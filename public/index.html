<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Rammerhead</title>
    <link rel="icon" type="image/png" id="favicon" href="favicon.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="browser-window">
        <!-- Tab Bar -->
        <div class="tab-bar" id="tab-bar">
            <button class="new-tab-button" id="new-tab-button" title="New Tab">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
            </button>
        </div>

        <!-- Browser Chrome -->
        <div class="browser-chrome">
            <button class="browser-button" id="back-button" disabled>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
            </button>
            <button class="browser-button" id="forward-button" disabled>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
            </button>
            <button class="browser-button" id="refresh-button">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
            </button>
            <div class="url-bar-wrapper">
                <svg class="security-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                </svg>
                <input 
                    type="text" 
                    id="url-input" 
                    class="url-input" 
                    placeholder="Search Bing or type a URL"
                    autocomplete="off"
                />
                <button class="page-action" id="clear-button" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Browser Content -->
        <div class="browser-content" id="browser-content">
            <!-- Tab contents will be dynamically added here -->
        </div>
    </div>

    <script>
        (function() {
            // Redirect to correct domain if needed
            const targetHost = '192.168.1.198';
            const targetPort = '8080';
            const currentHost = window.location.hostname;
            const currentPort = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            
            if (currentHost !== targetHost || currentPort !== targetPort) {
                const currentPath = window.location.pathname;
                const redirectUrl = `http://${targetHost}:${targetPort}${currentPath}${window.location.search}${window.location.hash}`;
                window.location.replace(redirectUrl);
                return;
            }
            
            // Detect base path
            function getBasePath() {
                const path = window.location.pathname;
                if (path.startsWith('/rammerhead')) {
                    return '/rammerhead';
                }
                return '';
            }
            
            const basePath = getBasePath();
            
            // Session Management - One session per device
            function getDeviceSessionId() {
                let sessionId = localStorage.getItem('deviceSessionId');
                if (!sessionId) {
                    // Generate new session ID
                    sessionId = generateSessionId();
                    localStorage.setItem('deviceSessionId', sessionId);
                }
                return sessionId;
            }

            function generateSessionId() {
                return Array.from(crypto.getRandomValues(new Uint8Array(16)))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            }

            function setDeviceSessionId(sessionId) {
                localStorage.setItem('deviceSessionId', sessionId);
            }

            // Tab Management
            let tabs = [];
            let activeTabId = null;
            let tabIdCounter = 0;

            const tabBar = document.getElementById('tab-bar');
            const browserContent = document.getElementById('browser-content');
            const newTabButton = document.getElementById('new-tab-button');
            const urlInput = document.getElementById('url-input');
            const clearButton = document.getElementById('clear-button');
            const backButton = document.getElementById('back-button');
            const forwardButton = document.getElementById('forward-button');
            const refreshButton = document.getElementById('refresh-button');

            // URL normalization function
            function normalizeUrl(url) {
                url = url.trim();
                // Check if it looks like a URL
                if (url.match(/^https?:\/\//i) || url.match(/^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}/)) {
                    if (!url.match(/^https?:\/\//i)) {
                        url = 'https://' + url;
                    }
                } else {
                    // Treat as search query - use Bing
                    url = 'https://www.bing.com/search?q=' + encodeURIComponent(url);
                }
                return url;
            }

            function createTab(url = 'jq://newtab/', title = 'New Tab') {
                const tabId = `tab-${++tabIdCounter}`;
                const tab = {
                    id: tabId,
                    url: url,
                    title: title,
                    canGoBack: false,
                    canGoForward: false
                };
                tabs.push(tab);

                // Create tab element
                const tabElement = document.createElement('div');
                tabElement.className = 'tab';
                tabElement.dataset.tabId = tabId;
                tabElement.innerHTML = `
                    <span class="tab-title">${title}</span>
                    <button class="tab-close" onclick="closeTab('${tabId}')">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                `;
                tabElement.addEventListener('click', (e) => {
                    if (!e.target.closest('.tab-close')) {
                        switchToTab(tabId);
                    }
                });

                // Insert before new tab button
                tabBar.insertBefore(tabElement, newTabButton);

                // Create tab content
                const contentElement = document.createElement('div');
                contentElement.className = 'tab-content';
                contentElement.id = `content-${tabId}`;
                contentElement.dataset.tabId = tabId;
                browserContent.appendChild(contentElement);

                // Load content
                loadTabContent(tabId, url);

                // Make it active
                switchToTab(tabId);

                return tabId;
            }

            function closeTab(tabId) {
                const tabIndex = tabs.findIndex(t => t.id === tabId);
                if (tabIndex === -1) return;

                tabs.splice(tabIndex, 1);

                // Remove tab element
                const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                if (tabElement) tabElement.remove();

                // Remove content
                const contentElement = document.getElementById(`content-${tabId}`);
                if (contentElement) contentElement.remove();

                // Switch to another tab if this was active
                if (activeTabId === tabId) {
                    if (tabs.length > 0) {
                        switchToTab(tabs[tabs.length - 1].id);
                    } else {
                        activeTabId = null;
                        createTab();
                    }
                }
            }

            function switchToTab(tabId) {
                activeTabId = tabId;

                // Update tab appearance
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const activeTabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                if (activeTabElement) activeTabElement.classList.add('active');

                // Update content visibility
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                const activeContent = document.getElementById(`content-${tabId}`);
                if (activeContent) activeContent.classList.add('active');

                // Update URL bar
                const tab = tabs.find(t => t.id === tabId);
                if (tab) {
                    urlInput.value = tab.url;
                    updateNavigationButtons(tab);
                }
            }

            async function loadTabContent(tabId, url) {
                const tab = tabs.find(t => t.id === tabId);
                if (!tab) return;

                const contentElement = document.getElementById(`content-${tabId}`);
                if (!contentElement) return;

                // Handle special URLs
                if (url.startsWith('jq://')) {
                    handleSpecialUrl(tabId, url);
                    return;
                }

                // Normalize URL before processing
                const normalizedUrl = normalizeUrl(url);
                const sessionId = getDeviceSessionId();
                
                // Ensure session exists and get proxied URL with proper shuffling
                try {
                    const response = await fetch(`${basePath}/getproxiedurl?id=${encodeURIComponent(sessionId)}&url=${encodeURIComponent(normalizedUrl)}`);
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    const data = await response.json();
                    const proxiedUrl = data.proxiedUrl || `${basePath}/${sessionId}/${normalizedUrl}`;
                    
                    contentElement.innerHTML = `<iframe src="${proxiedUrl}" style="width: 100%; height: 100%; border: none;"></iframe>`;
                } catch (e) {
                    console.error('Failed to get proxied URL:', e);
                    // Fallback: ensure session and use direct URL
                    try {
                        await fetch(`${basePath}/ensuresession?id=${encodeURIComponent(sessionId)}`);
                    } catch (e2) {
                        console.error('Failed to ensure session:', e2);
                    }
                    const proxiedUrl = `${basePath}/${sessionId}/${normalizedUrl}`;
                    contentElement.innerHTML = `<iframe src="${proxiedUrl}" style="width: 100%; height: 100%; border: none;"></iframe>`;
                }
                
                // Update tab title from iframe
                const iframe = contentElement.querySelector('iframe');
                if (iframe) {
                    iframe.onload = () => {
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            const title = iframeDoc.title || new URL(normalizedUrl).hostname;
                            updateTabTitle(tabId, title);
                        } catch (e) {
                            // Cross-origin, use URL hostname
                            try {
                                const urlObj = new URL(normalizedUrl);
                                updateTabTitle(tabId, urlObj.hostname);
                            } catch (e2) {
                                updateTabTitle(tabId, 'Page');
                            }
                        }
                    };
                }
            }

            function handleSpecialUrl(tabId, url) {
                const contentElement = document.getElementById(`content-${tabId}`);
                
                if (url === 'jq://home/') {
                    contentElement.innerHTML = getHomePageHTML();
                    updateTabTitle(tabId, 'Home');
                    initHomePage();
                } else if (url === 'jq://newtab/') {
                    contentElement.innerHTML = getNewTabHTML();
                    updateTabTitle(tabId, 'New Tab');
                } else if (url === 'jq://sessions/') {
                    contentElement.innerHTML = getSessionsPageHTML();
                    updateTabTitle(tabId, 'Sessions');
                    initSessionsPage();
                } else if (url === 'jq://settings/') {
                    contentElement.innerHTML = getSettingsPageHTML();
                    updateTabTitle(tabId, 'Settings');
                    initSettingsPage();
                }
            }

            function getHomePageHTML() {
                return `
                    <div class="home-page">
                        <div class="page-header">
                            <h1>Browser Pages</h1>
                            <p>Access internal browser pages</p>
                        </div>
                        <div class="home-grid">
                            <a href="jq://newtab/" class="home-card" data-url="jq://newtab/">
                                <div class="home-card-icon">üîç</div>
                                <div class="home-card-title">New Tab</div>
                                <div class="home-card-desc">Search and browse the web</div>
                            </a>
                            <a href="jq://sessions/" class="home-card" data-url="jq://sessions/">
                                <div class="home-card-icon">üîê</div>
                                <div class="home-card-title">Sessions</div>
                                <div class="home-card-desc">Manage your proxy session</div>
                            </a>
                            <a href="jq://settings/" class="home-card" data-url="jq://settings/">
                                <div class="home-card-icon">‚öôÔ∏è</div>
                                <div class="home-card-title">Settings</div>
                                <div class="home-card-desc">Customize your browser</div>
                            </a>
                        </div>
                    </div>
                `;
            }

            function initHomePage() {
                document.querySelectorAll('.home-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        e.preventDefault();
                        const url = card.dataset.url;
                        if (url) {
                            createTab(url);
                        }
                    });
                });
            }

            function getNewTabHTML() {
                const pageTitle = localStorage.getItem('pageTitle') || 'Rammerhead Proxy';
                return `
                    <div class="new-tab-content">
                        <div class="new-tab-logo-container">
                            <svg class="bing-logo" viewBox="0 0 200 200" fill="#008373">
                                <path d="M100 50c-27.6 0-50 22.4-50 50s22.4 50 50 50 50-22.4 50-50-22.4-50-50-50zm0 80c-16.6 0-30-13.4-30-30s13.4-30 30-30 30 13.4 30 30-13.4 30-30 30z"/>
                                <path d="M100 70l20 20-20 20-20-20 20-20z"/>
                            </svg>
                        </div>
                        <div class="new-tab-title">${pageTitle}</div>
                        <div class="new-tab-subtitle">Fast, secure web browsing</div>
                        <div class="search-box">
                            <div class="search-input-wrapper">
                                <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                                <input type="text" class="search-input" id="newtab-search-input" placeholder="Search Bing or type a URL" autocomplete="off" />
            </div>
                            <div class="search-buttons">
                                <button class="search-button" id="newtab-go-button">Bing Search</button>
                                <button class="search-button" id="newtab-lucky-button">I'm Feeling Lucky</button>
            </div>
        </div>
                        <div class="generate-link-section">
                            <button class="generate-link-button" id="newtab-generate-link-button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
                                </svg>
                                Generate never-expire link
                            </button>
                            <div class="link-result" id="newtab-link-result">
                                <div class="link-result-label">Never-expire link:</div>
                                <div class="link-display">
                                    <div class="link-url" id="newtab-link-url"></div>
                                    <button class="copy-button" id="newtab-copy-button">Copy</button>
            </div>
                </div>
                            <div class="error-message" id="newtab-error-message"></div>
                            <div class="loading" id="newtab-loading">
                                <span class="spinner"></span>
                                Creating session...
            </div>
        </div>
    </div>
                `;
            }

            function getSessionsPageHTML() {
                const sessionId = getDeviceSessionId();
                return `
                    <div class="sessions-page">
                        <div class="page-header">
                            <h1>Session Management</h1>
                            <p>Manage your proxy session ID</p>
                        </div>
                        <div class="sessions-section">
                            <h2>Current Session</h2>
                            <div class="session-id-display" id="current-session-id">${sessionId}</div>
                            <div class="form-group">
                                <label for="new-session-id">Change Session ID</label>
                                <input type="text" id="new-session-id" placeholder="Enter new session ID" />
                            </div>
                            <div class="button-group">
                                <button class="button" id="update-session-button">Update Session ID</button>
                                <button class="button button-secondary" id="generate-session-button">Generate New Session ID</button>
                            </div>
                            <div class="success-message" id="session-success-message"></div>
                            <div class="error-message" id="session-error-message"></div>
                        </div>
                    </div>
                `;
            }

            function getSettingsPageHTML() {
                const pageTitle = localStorage.getItem('pageTitle') || 'Rammerhead Proxy';
                const faviconData = localStorage.getItem('faviconData');
                return `
                    <div class="settings-page">
                        <div class="page-header">
                            <h1>Settings</h1>
                            <p>Customize your browser experience</p>
                        </div>
                        <div class="settings-section">
                            <h2>Page Title</h2>
                            <div class="form-group">
                                <label for="page-title-input">Current Title</label>
                                <input type="text" id="page-title-input" value="${pageTitle}" placeholder="Enter page title" />
                            </div>
                            <button class="button" id="save-title-button">Save Title</button>
                        </div>
                        <div class="settings-section">
                            <h2>Favicon</h2>
                            <div class="form-group">
                                <label for="favicon-input">Upload Favicon</label>
                                <input type="file" id="favicon-input" accept="image/*" />
                                ${faviconData ? `<img src="${faviconData}" class="preview-favicon" id="favicon-preview" />` : ''}
                            </div>
                            <button class="button" id="save-favicon-button">Save Favicon</button>
                        </div>
                        <div class="success-message" id="settings-success-message"></div>
                        <div class="error-message" id="settings-error-message"></div>
    </div>
                `;
            }

            function initSessionsPage() {
                const updateButton = document.getElementById('update-session-button');
                const generateButton = document.getElementById('generate-session-button');
                const newSessionIdInput = document.getElementById('new-session-id');
                const successMsg = document.getElementById('session-success-message');
                const errorMsg = document.getElementById('session-error-message');

                updateButton?.addEventListener('click', () => {
                    const newId = newSessionIdInput.value.trim();
                    if (!newId) {
                        showMessage(errorMsg, 'Please enter a session ID', 'error');
                        return;
                    }
                    setDeviceSessionId(newId);
                    showMessage(successMsg, 'Session ID updated successfully', 'success');
                    setTimeout(() => {
                        document.getElementById('current-session-id').textContent = newId;
                        newSessionIdInput.value = '';
                    }, 500);
                });

                generateButton?.addEventListener('click', () => {
                    const newId = generateSessionId();
                    setDeviceSessionId(newId);
                    newSessionIdInput.value = newId;
                    document.getElementById('current-session-id').textContent = newId;
                    showMessage(successMsg, 'New session ID generated', 'success');
                });
            }

            function initSettingsPage() {
                const saveTitleButton = document.getElementById('save-title-button');
                const saveFaviconButton = document.getElementById('save-favicon-button');
                const titleInput = document.getElementById('page-title-input');
                const faviconInput = document.getElementById('favicon-input');
                const successMsg = document.getElementById('settings-success-message');
                const errorMsg = document.getElementById('settings-error-message');

                saveTitleButton?.addEventListener('click', () => {
                    const title = titleInput.value.trim() || 'Rammerhead Proxy';
                    localStorage.setItem('pageTitle', title);
                    const titleElement = document.getElementById('page-title');
                    if (titleElement) {
                        titleElement.textContent = title;
                    }
                    // Update all new tab pages
                    document.querySelectorAll('.new-tab-title').forEach(el => {
                        el.textContent = title;
                    });
                    showMessage(successMsg, 'Title saved successfully', 'success');
                });

                saveFaviconButton?.addEventListener('click', () => {
                    const file = faviconInput.files[0];
                    if (!file) {
                        showMessage(errorMsg, 'Please select an image file', 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const faviconData = e.target.result;
                        localStorage.setItem('faviconData', faviconData);
                        const favicon = document.getElementById('favicon');
                        if (favicon) {
                            favicon.href = faviconData;
                        }
                        const preview = document.getElementById('favicon-preview');
                        if (preview) {
                            preview.src = faviconData;
                            preview.style.display = 'block';
                        } else {
                            const img = document.createElement('img');
                            img.src = faviconData;
                            img.className = 'preview-favicon';
                            img.id = 'favicon-preview';
                            faviconInput.parentElement.appendChild(img);
                        }
                        showMessage(successMsg, 'Favicon saved successfully', 'success');
                    };
                    reader.readAsDataURL(file);
                });
            }

            function showMessage(element, text, type) {
                if (!element) return;
                element.textContent = text;
                element.classList.add('active');
                setTimeout(() => element.classList.remove('active'), 3000);
            }

            function updateTabTitle(tabId, title) {
                const tab = tabs.find(t => t.id === tabId);
                if (tab) {
                    tab.title = title;
                    const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                    if (tabElement) {
                        const titleElement = tabElement.querySelector('.tab-title');
                        if (titleElement) titleElement.textContent = title;
                    }
                }
            }

            function updateNavigationButtons(tab) {
                backButton.disabled = !tab.canGoBack;
                forwardButton.disabled = !tab.canGoForward;
            }

            function navigateToUrl(url) {
                if (!activeTabId) return;
                const tab = tabs.find(t => t.id === activeTabId);
                if (!tab) return;

                // Normalize URL if it's not a special URL
                const finalUrl = url.startsWith('jq://') ? url : normalizeUrl(url);
                tab.url = finalUrl;
                urlInput.value = finalUrl;
                loadTabContent(activeTabId, finalUrl);
            }

            // Initialize new tab page handlers
            function initNewTabHandlers(contentElement) {
                const searchInput = contentElement.querySelector('#newtab-search-input');
                const goButton = contentElement.querySelector('#newtab-go-button');
                const luckyButton = contentElement.querySelector('#newtab-lucky-button');
                const generateButton = contentElement.querySelector('#newtab-generate-link-button');
                const copyButton = contentElement.querySelector('#newtab-copy-button');

                function handleNavigate() {
                    const url = searchInput.value.trim();
                    if (!url) return;
                    const normalized = normalizeUrl(url);
                    createTab(normalized);
                }

                goButton?.addEventListener('click', handleNavigate);
                searchInput?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleNavigate();
                });

                luckyButton?.addEventListener('click', () => {
                    const url = searchInput.value.trim();
                    if (!url) return;
                    createTab('https://www.bing.com/search?q=' + encodeURIComponent(url));
                });

                generateButton?.addEventListener('click', async () => {
                    const url = searchInput.value.trim();
                    if (!url) return;
                    const normalized = normalizeUrl(url);
                    try {
                        const response = await fetch(`${basePath}/generatelink?url=${encodeURIComponent(normalized)}`);
                        const data = await response.json();
                        if (data.url) {
                            const linkResult = contentElement.querySelector('#newtab-link-result');
                            const linkUrl = contentElement.querySelector('#newtab-link-url');
                            linkUrl.textContent = data.url;
                            linkResult.classList.add('active');
                        }
                    } catch (e) {
                        console.error('Failed to generate link', e);
                    }
                });

                copyButton?.addEventListener('click', () => {
                    const linkUrl = contentElement.querySelector('#newtab-link-url');
                    navigator.clipboard.writeText(linkUrl.textContent);
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => copyButton.textContent = 'Copy', 2000);
                });
            }

            // Event listeners
            newTabButton.addEventListener('click', () => createTab());
            urlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    navigateToUrl(urlInput.value);
                }
            });
            clearButton.addEventListener('click', () => {
                urlInput.value = '';
                clearButton.style.display = 'none';
            });
            urlInput.addEventListener('input', () => {
                clearButton.style.display = urlInput.value ? 'block' : 'none';
            });
            refreshButton.addEventListener('click', () => {
                if (activeTabId) {
                    const tab = tabs.find(t => t.id === activeTabId);
                    if (tab) loadTabContent(activeTabId, tab.url);
                }
            });

            // Load saved settings on page load
            function loadSavedSettings() {
                const savedTitle = localStorage.getItem('pageTitle');
                if (savedTitle) {
                    const titleElement = document.getElementById('page-title');
                    if (titleElement) {
                        titleElement.textContent = savedTitle;
                    }
                }
                const savedFavicon = localStorage.getItem('faviconData');
                if (savedFavicon) {
                    const faviconElement = document.getElementById('favicon');
                    if (faviconElement) {
                        faviconElement.href = savedFavicon;
                    }
                }
            }
            
            // Load settings immediately
            loadSavedSettings();

            // Create initial tab
            createTab('jq://home/');

            // Re-initialize new tab handlers when content is loaded
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1 && node.classList.contains('tab-content')) {
                            const newtabContent = node.querySelector('.new-tab-content');
                            if (newtabContent) {
                                setTimeout(() => initNewTabHandlers(node), 100);
                            }
                        }
                    });
                });
            });
            observer.observe(browserContent, { childList: true, subtree: true });

            // Make closeTab available globally
            window.closeTab = closeTab;
        })();
    </script>
</body>
</html>
