<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Unlinewize</title>
    <link rel="icon" type="image/png" id="favicon" href="favicon.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style id="embedded-styles">
/* ============================================
   CSS Variables & Reset
   ============================================ */
:root {
    /* Chrome-like colors - Light Mode */
    --color-white: #ffffff;
    --color-text-primary: #202124;
    --color-text-secondary: #3c4043;
    --color-text-muted: #5f6368;
    --color-text-placeholder: #80868b;
    --color-text-icon: #9aa0a6;
    --color-bg-primary: #ffffff;
    --color-bg-secondary: #f1f3f4;
    --color-bg-tertiary: #f8f9fa;
    --color-bg-hover: rgba(60, 64, 67, 0.08);
    --color-bg-active: rgba(60, 64, 67, 0.12);
    --color-bg-tab-active: #ffffff;
    --color-bg-tab-hover: rgba(0, 0, 0, 0.05);
    --color-bg-tab-inactive: #e8eaed;
    --color-border: #dadce0;
    --color-border-light: #dfe1e5;
    --color-border-hover: #c4c7c5;
    --color-border-divider: #e8eaed;
    --color-primary: #1a73e8;
    --color-primary-hover: #1557b0;
    --color-primary-active: #174ea6;
    --color-primary-light: #e8f0fe;
    --color-primary-secondary: #34a853;
    --color-link: #1a73e8;
    --color-link-hover: #1557b0;
    --color-error-bg: #fce8e6;
    --color-error-border: #f28b82;
    --color-error-text: #c5221f;
    --color-success: #137333;
    --color-success-bg: #e6f4ea;
    --font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    --font-family-mono: 'Consolas', 'Courier New', monospace;
    --transition-fast: 0.15s;
    --shadow-sm: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    --shadow-md: 0 1px 2px rgba(60, 64, 67, 0.3), 0 2px 6px 2px rgba(60, 64, 67, 0.15);
    --shadow-lg: 0 2px 4px rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
}

[data-theme="dark"] {
    /* Dark Mode Colors */
    --color-text-primary: #e8eaed;
    --color-text-secondary: #bdc1c6;
    --color-text-muted: #9aa0a6;
    --color-text-placeholder: #80868b;
    --color-text-icon: #5f6368;
    --color-bg-primary: #202124;
    --color-bg-secondary: #2d2e30;
    --color-bg-tertiary: #35363a;
    --color-bg-hover: rgba(255, 255, 255, 0.1);
    --color-bg-active: rgba(255, 255, 255, 0.15);
    --color-bg-tab-active: #2d2e30;
    --color-bg-tab-hover: rgba(255, 255, 255, 0.08);
    --color-bg-tab-inactive: #35363a;
    --color-border: #3c4043;
    --color-border-light: #5f6368;
    --color-border-hover: #80868b;
    --color-border-divider: #3c4043;
    --color-primary: #8ab4f8;
    --color-primary-hover: #aecbfa;
    --color-primary-active: #669df6;
    --color-primary-light: #1e3a5f;
    --color-primary-secondary: #81c995;
    --color-link: #8ab4f8;
    --color-link-hover: #aecbfa;
    --color-error-bg: #3c1e1e;
    --color-error-border: #8b5a5a;
    --color-error-text: #f28b82;
    --color-success: #81c995;
    --color-success-bg: #1e3a2e;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* ============================================
   Base Layout
   ============================================ */
body {
    font-family: var(--font-family);
    background: var(--color-bg-primary);
    color: var(--color-text-primary);
    margin: 0;
    padding: 0;
    height: 100vh;
    overflow: hidden;
}

.browser-window {
    width: 100%;
    height: 100vh;
    background: var(--color-bg-primary);
    display: flex;
    flex-direction: column;
}

/* ============================================
   Tab Bar - Chrome-like
   ============================================ */
.tab-bar {
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    align-items: flex-end;
    padding: 0;
    overflow-x: auto;
    overflow-y: hidden;
    flex-shrink: 0;
    min-height: 36px;
    height: 36px;
    gap: 0;
}

.tab-bar::-webkit-scrollbar {
    height: 4px;
}

.tab-bar::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.tab {
    position: relative;
    background: var(--color-bg-tab-inactive);
    border: 1px solid var(--color-border);
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    padding: 0 32px 0 16px;
    margin-right: -1px;
    margin-top: 0;
    cursor: pointer;
    user-select: none;
    min-width: 100px;
    max-width: 240px;
    height: 36px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    white-space: nowrap;
    overflow: hidden;
    flex-shrink: 0;
}

.tab:hover {
    background: var(--color-bg-tab-hover);
}

.tab.active {
    background: var(--color-bg-tab-active);
    z-index: 1;
    border-bottom: 1px solid var(--color-bg-tab-active);
    margin-bottom: -1px;
    margin-top: 0;
    height: 36px;
    box-shadow: 0 -1px 0 var(--color-bg-tab-active);
}

.tab-title {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13px;
    color: var(--color-text-primary);
}

.tab-close {
    position: absolute;
    right: 8px;
    width: 18px;
    height: 18px;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.6;
    transition: all var(--transition-fast);
}

.tab-close:hover {
    opacity: 1;
    background: var(--color-bg-hover);
}

.tab-close svg {
    width: 12px;
    height: 12px;
}

.new-tab-button {
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 6px 8px;
    color: var(--color-text-muted);
    transition: all var(--transition-fast);
}

.new-tab-button:hover {
    background: var(--color-bg-hover);
    color: var(--color-text-primary);
}

/* ============================================
   Browser Chrome (Top Bar) - Modern Chrome-like
   ============================================ */
.browser-chrome {
    background: var(--color-bg-primary);
    border-bottom: 1px solid var(--color-border);
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
    height: 56px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.browser-button {
    width: 36px;
    height: 36px;
    border: none;
    background: transparent;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-icon);
    transition: all 0.2s ease;
    position: relative;
}

.browser-button:hover {
    background: var(--color-bg-hover);
    color: var(--color-text-primary);
}

.browser-button:active {
    background: var(--color-bg-active);
}

.browser-button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.browser-button svg {
    width: 18px;
    height: 18px;
}

.url-bar-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    background: var(--color-bg-secondary);
    border: 1px solid transparent;
    border-radius: 24px;
    padding: 0 16px;
    margin: 0 8px;
    height: 40px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}

.url-bar-wrapper:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    background: var(--color-bg-primary);
}

.url-bar-wrapper:focus-within {
    box-shadow: 0 2px 8px rgba(26, 115, 232, 0.2);
    border-color: var(--color-primary);
    background: var(--color-bg-primary);
    outline: 2px solid var(--color-primary-light);
    outline-offset: -2px;
}

.security-icon {
    width: 16px;
    height: 16px;
    margin-right: 12px;
    flex-shrink: 0;
    color: var(--color-text-muted);
}

.url-input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 14px;
    color: var(--color-text-primary);
    font-family: var(--font-family);
    background: transparent;
}

.url-input::placeholder {
    color: var(--color-text-placeholder);
}

.page-action {
    width: 20px;
    height: 20px;
    border: none;
    background: transparent;
    cursor: pointer;
    color: var(--color-text-muted);
    margin-left: 8px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.page-action:hover {
    color: var(--color-text-primary);
}

/* ============================================
   Browser Content Area
   ============================================ */
.browser-content {
    flex: 1;
    overflow: hidden;
    position: relative;
}

.tab-content {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
    overflow-y: auto;
    background: var(--color-bg-primary);
}

.tab-content.active {
    display: flex;
    flex-direction: column;
}

.tab-content iframe {
    width: 100%;
    height: 100%;
    border: none;
}

.new-tab-content {
    padding: 80px 40px 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    text-align: center;
    max-width: 652px;
    margin: 0 auto;
    min-height: 100%;
}

.new-tab-logo-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 24px;
}

.favicon-logo {
    width: 72px;
    height: 72px;
    object-fit: contain;
}

.new-tab-logo {
    font-size: 72px;
    font-weight: 300;
    color: #008373;
    letter-spacing: -2px;
}

.new-tab-title {
    font-size: 28px;
    font-weight: 400;
    color: var(--color-text-primary);
    margin-bottom: 8px;
    letter-spacing: -0.5px;
}

.new-tab-subtitle {
    font-size: 15px;
    color: var(--color-text-muted);
    margin-bottom: 40px;
}

/* ============================================
   Search Box & Input
   ============================================ */
.search-box {
    width: 100%;
    max-width: 584px;
    margin: 0 auto 24px;
    position: relative;
}

.search-input-wrapper {
    display: flex;
    align-items: center;
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 24px;
    padding: 0 16px;
    height: 44px;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-fast);
}

.search-input-wrapper:hover {
    box-shadow: var(--shadow-md);
    border-color: transparent;
}

.search-input-wrapper:focus-within {
    box-shadow: var(--shadow-md);
    border-color: transparent;
}

.search-icon {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    color: var(--color-text-icon);
    flex-shrink: 0;
}

.search-input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 16px;
    color: var(--color-text-primary);
    font-family: var(--font-family);
    background: transparent;
}

.search-input::placeholder {
    color: var(--color-text-icon);
}

/* ============================================
   Buttons
   ============================================ */
.search-buttons {
    display: flex;
    gap: 11px;
    justify-content: center;
    margin-bottom: 32px;
}

.search-button {
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-bg-tertiary);
    border-radius: 4px;
    padding: 11px 16px;
    font-size: 14px;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: var(--font-family);
}

.search-button:hover {
    box-shadow: var(--shadow-sm);
    background: var(--color-bg-tertiary);
    border-color: var(--color-border);
}

.generate-link-button {
    background: var(--color-primary);
    border: none;
    border-radius: 4px;
    padding: 10px 24px;
    color: var(--color-white);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background var(--transition-fast);
    font-family: var(--font-family);
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.generate-link-button:hover {
    background: var(--color-primary-hover);
}

.generate-link-button:active {
    background: var(--color-primary-active);
}

.generate-link-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.copy-button {
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 8px 16px;
    color: var(--color-text-secondary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
    font-family: var(--font-family);
}

.copy-button:hover {
    background: var(--color-bg-tertiary);
    border-color: var(--color-border-hover);
}

.copy-button.copied {
    background: var(--color-primary-light);
    border-color: var(--color-primary);
    color: var(--color-primary);
}

/* ============================================
   Link Generation Section
   ============================================ */
.generate-link-section {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--color-border-divider);
    width: 100%;
    max-width: 584px;
}

.link-result {
    display: none;
    margin-top: 16px;
    padding: 16px;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    width: 100%;
}

.link-result.active {
    display: block;
}

.link-result-label {
    font-size: 12px;
    color: var(--color-text-muted);
    margin-bottom: 8px;
    font-weight: 500;
}

.link-display {
    display: flex;
    gap: 8px;
    align-items: center;
}

.link-url {
    flex: 1;
    font-family: var(--font-family-mono);
    font-size: 13px;
    color: var(--color-primary);
    background: var(--color-bg-primary);
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid var(--color-border);
    word-break: break-all;
}

/* ============================================
   Internal Pages (Chrome-like)
   ============================================ */
.home-page, .settings-page, .sessions-page {
    padding: 48px 24px;
    max-width: 960px;
    margin: 0 auto;
    background: var(--color-bg-primary);
    min-height: 100%;
}

.page-header {
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--color-border-divider);
}

.page-header h1 {
    font-size: 32px;
    font-weight: 400;
    color: var(--color-text-primary);
    margin-bottom: 8px;
    letter-spacing: -0.5px;
}

.page-header p {
    font-size: 15px;
    color: var(--color-text-muted);
    line-height: 1.5;
}

.home-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 16px;
    margin-top: 24px;
    max-width: 100%;
}

.home-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 16px 12px;
    text-decoration: none;
    color: inherit;
    transition: all var(--transition-fast);
    cursor: pointer;
    min-height: 140px;
    justify-content: center;
}

.home-card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 2px 8px rgba(26, 115, 232, 0.15);
    transform: translateY(-2px);
}

.home-card-icon {
    font-size: 32px;
    margin-bottom: 12px;
    line-height: 1;
    color: var(--color-primary);
}

.home-card-title {
    font-size: 16px;
    font-weight: 500;
    color: var(--color-text-primary);
    margin-bottom: 6px;
}

.home-card-desc {
    font-size: 12px;
    color: var(--color-text-muted);
    line-height: 1.4;
}

.settings-section, .sessions-section {
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
}

.settings-section h2, .sessions-section h2 {
    font-size: 20px;
    font-weight: 500;
    color: var(--color-text-primary);
    margin-bottom: 20px;
    letter-spacing: -0.2px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--color-text-primary);
    margin-bottom: 8px;
}

.form-group input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 14px;
    font-family: var(--font-family);
    color: var(--color-text-primary);
    background: var(--color-bg-primary);
    transition: all var(--transition-fast);
}

.form-group input[type="file"] {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 14px;
    font-family: var(--font-family);
    background: var(--color-bg-primary);
}

.form-group input[type="text"]:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-light);
}

.form-group input[type="text"]:hover {
    border-color: var(--color-border-hover);
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 14px;
    font-family: var(--font-family);
    color: var(--color-text-primary);
    background: var(--color-bg-primary);
    transition: all var(--transition-fast);
}

.form-control:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-light);
}

.form-control:hover {
    border-color: var(--color-border-hover);
}

.button {
    background: var(--color-primary);
    border: none;
    border-radius: 4px;
    padding: 10px 24px;
    color: var(--color-white);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background var(--transition-fast);
    font-family: var(--font-family);
}

.button:hover {
    background: var(--color-primary-hover);
}

.button-secondary {
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    color: var(--color-text-primary);
}

.button-secondary:hover {
    background: var(--color-bg-hover);
}

.session-id-display {
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 12px 16px;
    font-family: var(--font-family-mono);
    font-size: 13px;
    color: var(--color-text-primary);
    word-break: break-all;
    margin-bottom: 20px;
    line-height: 1.6;
}

.button-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.preview-favicon {
    width: 32px;
    height: 32px;
    margin-top: 8px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
}

/* ============================================
   Status Messages
   ============================================ */
.error-message {
    display: none;
    margin-top: 16px;
    padding: 12px 16px;
    background: var(--color-error-bg);
    border: 1px solid var(--color-error-border);
    border-radius: 4px;
    color: var(--color-error-text);
    font-size: 13px;
    text-align: center;
}

.error-message.active {
    display: block;
}

.success-message {
    display: none;
    margin-top: 16px;
    padding: 12px 16px;
    background: #e6f4ea;
    border: 1px solid #34a853;
    border-radius: 4px;
    color: var(--color-success);
    font-size: 13px;
  text-align: center;
}

.success-message.active {
    display: block;
}

.loading {
    display: none;
    text-align: center;
    margin-top: 16px;
    color: var(--color-text-muted);
    font-size: 13px;
}

.loading.active {
    display: block;
}

.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--color-border-divider);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}

/* ============================================
   Animations
   ============================================ */
@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(20px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

/* ============================================
   Responsive Design
   ============================================ */
@media (max-width: 768px) {
    .new-tab-content, .settings-page, .sessions-page, .home-page {
        padding: 24px 16px;
    }

    .search-input-wrapper {
        height: 40px;
    }

    .search-buttons {
        flex-direction: column;
        align-items: center;
    }

    .search-button {
        width: 100%;
        max-width: 200px;
    }

    .tab {
        min-width: 100px;
        max-width: 180px;
    }
}

/* ============================================
   Bookmark Bar
   ============================================ */
.bookmark-bar {
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
    padding: 4px 8px;
    display: flex;
    align-items: center;
    min-height: 32px;
    flex-shrink: 0;
}

.bookmark-items {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    align-items: center;
}

.bookmark-item {
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.bookmark-item:hover {
    background: var(--color-bg-hover);
}

.bookmark-item i {
    font-size: 12px;
    color: var(--color-text-icon);
}

/* ============================================
   Menu Dropdown - Chrome-like
   ============================================ */
.menu-dropdown {
    position: fixed;
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 4px 16px rgba(0, 0, 0, 0.1);
    min-width: 220px;
    z-index: 10000;
    padding: 6px 0;
    margin-top: 4px;
    display: none;
}

.menu-item {
    padding: 10px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--color-text-primary);
    font-size: 14px;
}

.menu-item:hover {
    background: var(--color-bg-hover);
}

.menu-item i {
    width: 16px;
    text-align: center;
    color: var(--color-text-icon);
}

.menu-divider {
    height: 1px;
    background: var(--color-border-divider);
    margin: 4px 0;
}

.browser-controls, .browser-actions {
    display: flex;
    align-items: center;
    gap: 4px;
}

.download-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--color-primary);
    color: var(--color-white);
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: 600;
    min-width: 18px;
    text-align: center;
    line-height: 14px;
}

.browser-button {
    position: relative;
}

.browser-chrome {
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
}

/* ============================================
   DevTools Panel
   ============================================ */
.devtools-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--color-bg-primary);
    border-top: 1px solid var(--color-border);
    height: 400px;
    display: none;
    flex-direction: column;
    z-index: 10001;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
}

.devtools-panel.active {
    display: flex;
}

.devtools-header {
    display: flex;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid var(--color-border);
    gap: 8px;
}

.devtools-tabs {
    display: flex;
    gap: 4px;
}

.devtools-tab {
    padding: 6px 12px;
    border: none;
    background: transparent;
    color: var(--color-text-secondary);
    cursor: pointer;
    border-radius: 4px;
    font-size: 13px;
}

.devtools-tab.active {
    background: var(--color-bg-hover);
    color: var(--color-text-primary);
}

.devtools-content {
    flex: 1;
    overflow: auto;
    padding: 16px;
    font-family: var(--font-family-mono);
    font-size: 12px;
}

.devtools-close {
    margin-left: auto;
    padding: 4px 8px;
    border: none;
    background: transparent;
    color: var(--color-text-icon);
    cursor: pointer;
}

.network-table {
    width: 100%;
    border-collapse: collapse;
}

.network-table th,
.network-table td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
}

.network-table th {
    background: var(--color-bg-secondary);
    font-weight: 500;
    position: sticky;
    top: 0;
}

/* ============================================
   Additional Feature Styles
   ============================================ */
.feature-page {
    padding: 24px;
    max-width: 1200px;
    margin: 0 auto;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 24px;
}

.feature-card {
    padding: 16px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-bg-primary);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.feature-card:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-sm);
}

.feature-card-icon {
    font-size: 24px;
    margin-bottom: 8px;
    color: var(--color-primary);
}

.feature-card-title {
    font-weight: 500;
    margin-bottom: 4px;
}

.feature-card-desc {
    font-size: 13px;
    color: var(--color-text-secondary);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
}

.data-table th {
    background: var(--color-bg-secondary);
    font-weight: 500;
}

.data-table tr:hover {
    background: var(--color-bg-hover);
}

.action-buttons {
    display: flex;
    gap: 8px;
    margin-top: 16px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 24px;
}

.stat-card {
    padding: 20px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-bg-primary);
}

.stat-value {
    font-size: 32px;
    font-weight: 600;
    color: var(--color-primary);
    margin-bottom: 8px;
}

.stat-label {
    color: var(--color-text-secondary);
    font-size: 14px;
}

</style>

    <script>
        // Fallback: Load CSS dynamically if link fails
        (function() {
            const link = document.querySelector('link[href*="styles.css"]');
            if (link) {
                const loadCSS = () => {
                    fetch('/styles.css?t=' + Date.now())
                        .then(r => r.ok ? r.text() : fetch('/style.css?t=' + Date.now()).then(r2 => r2.ok ? r2.text() : ''))
                        .then(css => {
                            if (css && css.length > 100) {
                                const style = document.createElement('style');
                                style.textContent = css;
                                document.head.appendChild(style);
                                console.log('CSS loaded dynamically');
                            }
                        })
                        .catch(() => {});
                };
                link.onerror = loadCSS;
                // Also try loading after a short delay in case onerror doesn't fire
                setTimeout(() => {
                    if (!document.querySelector('style[data-dynamic-css]')) {
                        loadCSS();
                    }
                }, 100);
            }
        })();
    </script>
</head>
<body>
    <div class="browser-window">
        <!-- Tab Bar -->
        <div class="tab-bar" id="tab-bar">
            <button class="new-tab-button" id="new-tab-button" title="New Tab">
                <i class="fas fa-plus"></i>
            </button>
            </div>

        <!-- Browser Chrome -->
        <div class="browser-chrome">
            <div class="browser-controls">
                <button class="browser-button" id="back-button" title="Back">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <button class="browser-button" id="forward-button" title="Forward">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <button class="browser-button" id="refresh-button" title="Refresh">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="browser-button" id="home-button" title="Home">
                    <i class="fas fa-home"></i>
                </button>
        </div>
            <div class="url-bar-wrapper">
                <i class="fas fa-lock security-icon" id="security-icon"></i>
                <input 
                    type="text" 
                    id="url-input" 
                    class="url-input" 
                    placeholder="Search or type a URL"
                    autocomplete="off"
                />
                <button class="page-action" id="clear-button" style="display: none;" title="Clear">
                    <i class="fas fa-times"></i>
                </button>
                <button class="page-action" id="bookmark-button" title="Bookmark this page">
                    <i class="far fa-star"></i>
                </button>
            </div>
            <div class="browser-actions">
                <button class="browser-button" id="downloads-button" title="Downloads">
                    <i class="fas fa-download"></i>
                    <span class="download-badge" id="download-badge" style="display: none;">0</span>
                </button>
                <button class="browser-button" id="menu-button" title="Menu">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>
        
        <!-- Bookmark Bar -->
        <div class="bookmark-bar" id="bookmark-bar" style="display: none;">
            <div class="bookmark-items" id="bookmark-items"></div>
            </div>
        
        <!-- Menu Dropdown -->
        <div class="menu-dropdown" id="menu-dropdown" style="display: none;">
            <div class="menu-item" data-action="new-tab">
                <i class="fas fa-plus"></i> New Tab
            </div>
            <div class="menu-divider"></div>
            <div class="menu-item" data-action="bookmarks">
                <i class="fas fa-bookmark"></i> Bookmarks
        </div>
            <div class="menu-item" data-action="history">
                <i class="fas fa-history"></i> History
            </div>
            <div class="menu-divider"></div>
            <div class="menu-item" data-action="settings">
                <i class="fas fa-cog"></i> Settings
                </div>
            <div class="menu-item" data-action="devtools">
                <i class="fas fa-code"></i> Developer Tools
            </div>
            <div class="menu-divider"></div>
            <div class="menu-item" data-action="theme">
                <i class="fas fa-moon" id="theme-icon"></i> <span id="theme-text">Dark Mode</span>
        </div>
    </div>

        <!-- Browser Content -->
        <div class="browser-content" id="browser-content">
            <!-- Tab contents will be dynamically added here -->
            </div>
        </div>

    <script>
        (function() {
            // Redirect to correct domain if needed - but allow tunnel URLs (loca.lt, etc.)
            const targetHost = '192.168.1.198';
            const targetPort = '8080';
            const currentHost = window.location.hostname;
            const currentPort = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            
            // Check if we're on a tunnel URL or deployed domain - don't redirect those
            const isTunnelUrl = currentHost.includes('.loca.lt') || 
                               currentHost.includes('.ngrok.io') || 
                               currentHost.includes('.ngrok-free.app') ||
                               currentHost.includes('.cloudflared.net') ||
                               currentHost.includes('.onrender.com') ||
                               currentHost.includes('.railway.app') ||
                               currentHost.includes('.fly.dev') ||
                               currentHost.includes('.vercel.app') ||
                               currentHost.includes('.repl.co') ||
                               currentHost.includes('.replit.dev') ||
                               currentHost.includes('replit.com') ||
                               currentHost.includes('tunnel') ||
                               window.location.protocol === 'https:';
            
            // Only redirect if not on tunnel and not on the correct local address
            if (!isTunnelUrl && (currentHost !== targetHost || currentPort !== targetPort)) {
                // Always redirect exactly to http://192.168.1.198:8080/ (root path only, ignore current path/query/hash)
                const redirectUrl = `http://${targetHost}:${targetPort}/`;
                window.location.replace(redirectUrl);
                return; // Stop execution until redirect completes
            }
            
            // Detect base path
            function getBasePath() {
                const path = window.location.pathname;
                if (path.startsWith('/rammerhead')) {
                    return '/rammerhead';
                }
                return '';
            }
            
            const basePath = getBasePath();

            const _jqFooterHTML = '<footer style="text-align: center; padding: 24px 0 16px; color: #888; font-size: 13px;">&copy; JimmyQrg 2026</footer>';

            // ============================================
            // URL Shuffler (client-side mirror of server StrShuffler)
            // ============================================
            const _shufflerBaseDictionary = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz~-';
            const _shuffledIndicator = '_rhs';
            const _mod = (n, m) => ((n % m) + m) % m;

            class StrShuffler {
                constructor(dictionary) {
                    this.dictionary = dictionary;
                }
                shuffle(str) {
                    if (str.startsWith(_shuffledIndicator)) return str;
                    let out = '';
                    for (let i = 0; i < str.length; i++) {
                        const ch = str.charAt(i);
                        const idx = _shufflerBaseDictionary.indexOf(ch);
                        if (ch === '%' && str.length - i >= 3) {
                            out += ch; out += str.charAt(++i); out += str.charAt(++i);
                        } else if (idx === -1) {
                            out += ch;
                        } else {
                            out += this.dictionary.charAt(_mod(idx + i, _shufflerBaseDictionary.length));
                        }
                    }
                    return _shuffledIndicator + out;
                }
                unshuffle(str) {
                    if (!str.startsWith(_shuffledIndicator)) return str;
                    str = str.slice(_shuffledIndicator.length);
                    let out = '';
                    for (let i = 0; i < str.length; i++) {
                        const ch = str.charAt(i);
                        const idx = this.dictionary.indexOf(ch);
                        if (ch === '%' && str.length - i >= 3) {
                            out += ch; out += str.charAt(++i); out += str.charAt(++i);
                        } else if (idx === -1) {
                            out += ch;
                        } else {
                            out += _shufflerBaseDictionary.charAt(_mod(idx - i, _shufflerBaseDictionary.length));
                        }
                    }
                    return out;
                }
            }

            let _shuffler = null; // Will be initialized when shuffle dict is fetched

            async function getShuffler() {
                if (_shuffler) return _shuffler;
                try {
                    const sessionId = getDeviceSessionId();
                    const resp = await fetch(`${basePath}/api/shuffleDict?id=${encodeURIComponent(sessionId)}`);
                    if (resp.ok) {
                        const dictText = await resp.text();
                        const dict = JSON.parse(dictText);
                        if (dict) {
                            _shuffler = new StrShuffler(dict);
                        }
                    }
                } catch (e) {
                    console.warn('Could not fetch shuffle dict:', e);
                }
                return _shuffler;
            }

            /**
             * Extract the actual destination URL from a proxied iframe URL.
             * The proxy URL format: http://host:port/[basePath/]sessionId/shuffledUrl
             * where shuffledUrl is the entire destination URL (protocol + host + path + query + hash)
             * shuffled as one string.
             */
            function extractRealUrl(proxyUrl) {
                try {
                    // Work with the full URL string to avoid browser URL parsing issues
                    // Find the session ID pattern (32 hex chars) and extract everything after it
                    const match = proxyUrl.match(/\/([a-f0-9]{32})\/(.+)/);
                    if (match) {
                        const shuffledPart = match[2];
                        // Unshuffle using the client-side StrShuffler
                        if (_shuffler && shuffledPart.startsWith(_shuffledIndicator)) {
                            return _shuffler.unshuffle(shuffledPart);
                        }
                        // If not shuffled (no _rhs prefix), return as-is
                        if (!shuffledPart.startsWith(_shuffledIndicator)) {
                            return shuffledPart;
                        }
                        // Shuffled but no shuffler available â€” can't decode
                        return null;
                    }
                } catch (e) {
                    // Not a valid URL or extraction failed
                }
                return null;
            }

            // Session Management - One session per device
            function getDeviceSessionId() {
                let sessionId = localStorage.getItem('deviceSessionId');
                if (!sessionId) {
                    // Generate new session ID
                    sessionId = generateSessionId();
                    localStorage.setItem('deviceSessionId', sessionId);
                }
                return sessionId;
            }

            function generateSessionId() {
                return Array.from(crypto.getRandomValues(new Uint8Array(16)))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            }

            function setDeviceSessionId(sessionId) {
                localStorage.setItem('deviceSessionId', sessionId);
                _shuffler = null; // Invalidate shuffler so it's re-fetched for new session
            }

            // ============================================
            // Data Management Functions
            // ============================================
            
            // Bookmarks
            function getBookmarks() {
                const bookmarks = localStorage.getItem('bookmarks');
                return bookmarks ? JSON.parse(bookmarks) : [];
            }
            
            function saveBookmarks(bookmarks) {
                localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
            }
            
            function addBookmark(url, title) {
                const bookmarks = getBookmarks();
                if (!bookmarks.find(b => b.url === url)) {
                    bookmarks.push({ url, title, id: Date.now().toString() });
                    saveBookmarks(bookmarks);
                    updateBookmarkBar();
                    return true;
                }
                return false;
            }
            
            function removeBookmark(url) {
                const bookmarks = getBookmarks();
                const filtered = bookmarks.filter(b => b.url !== url);
                saveBookmarks(filtered);
                updateBookmarkBar();
            }
            
            function isBookmarked(url) {
                return getBookmarks().some(b => b.url === url);
            }
            
            // History
            function getHistory() {
                const history = localStorage.getItem('browserHistory');
                return history ? JSON.parse(history) : [];
            }
            
            function saveHistory(history) {
                // Keep only last 1000 entries
                const limited = history.slice(-1000);
                localStorage.setItem('browserHistory', JSON.stringify(limited));
            }
            
            function addToHistory(url, title) {
                if (url.startsWith('jq://')) return;
                const history = getHistory();
                history.push({
                    url,
                    title: title || url,
                    timestamp: Date.now()
                });
                saveHistory(history);
            }
            
            function clearHistory() {
                localStorage.removeItem('browserHistory');
            }
            
            function removeHistoryItem(url, timestamp) {
                const history = getHistory();
                const filtered = history.filter(item => !(item.url === url && item.timestamp === timestamp));
                saveHistory(filtered);
            }
            
            // Downloads
            function getDownloads() {
                const downloads = localStorage.getItem('downloads');
                return downloads ? JSON.parse(downloads) : [];
            }
            
            function saveDownloads(downloads) {
                localStorage.setItem('downloads', JSON.stringify(downloads));
            }
            
            function addDownload(url, filename) {
                const downloads = getDownloads();
                downloads.push({
                    url,
                    filename: filename || url.split('/').pop(),
                    timestamp: Date.now(),
                    status: 'completed'
                });
                saveDownloads(downloads);
                // Update badge
                if (typeof window.updateDownloadsBadge === 'function') {
                    window.updateDownloadsBadge();
                }
            }
            
            // Search Engines
            const searchEngines = {
                google: { name: 'Google', url: 'https://www.google.com/search?q=' },
                bing: { name: 'Bing', url: 'https://www.bing.com/search?q=' },
                duckduckgo: { name: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=' },
                yahoo: { name: 'Yahoo', url: 'https://search.yahoo.com/search?p=' }
            };
            
            function getSearchEngine() {
                return localStorage.getItem('searchEngine') || 'bing';
            }
            
            function setSearchEngine(engine) {
                localStorage.setItem('searchEngine', engine);
            }
            
            // Theme
            function getTheme() {
                return localStorage.getItem('theme') || 'light';
            }
            
            function setTheme(theme) {
                localStorage.setItem('theme', theme);
                document.documentElement.setAttribute('data-theme', theme);
                updateThemeUI();
            }
            
            function updateThemeUI() {
                const theme = getTheme();
                const icon = document.getElementById('theme-icon');
                const text = document.getElementById('theme-text');
                if (icon) {
                    icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                }
                if (text) {
                    text.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
                }
            }
            
            // Statistics
            function getStats() {
                const stats = localStorage.getItem('browserStats');
                return stats ? JSON.parse(stats) : {
                    sitesVisited: 0,
                    dataUsed: 0,
                    timeSpent: 0,
                    startDate: Date.now()
                };
            }
            
            function saveStats(stats) {
                localStorage.setItem('browserStats', JSON.stringify(stats));
            }
            
            function updateStats(url) {
                const stats = getStats();
                stats.sitesVisited++;
                saveStats(stats);
            }
            
            // Network Inspector
            let networkRequests = [];
            
            function addNetworkRequest(request) {
                networkRequests.push({
                    ...request,
                    id: Date.now().toString() + Math.random(),
                    timestamp: Date.now()
                });
                // Keep only last 500 requests
                if (networkRequests.length > 500) {
                    networkRequests = networkRequests.slice(-500);
                }
            }
            
            // Tab Management
            let tabs = [];
            let activeTabId = null;
            let tabIdCounter = 0;

            const tabBar = document.getElementById('tab-bar');
            const browserContent = document.getElementById('browser-content');
            const newTabButton = document.getElementById('new-tab-button');
            const urlInput = document.getElementById('url-input');
            const clearButton = document.getElementById('clear-button');
            const backButton = document.getElementById('back-button');
            const forwardButton = document.getElementById('forward-button');
            const refreshButton = document.getElementById('refresh-button');

            // URL normalization function
            function normalizeUrl(url) {
                url = url.trim();
                // Preserve special jq:// URLs
                if (url.startsWith('jq://')) {
                    return url;
                }
                // Check if it looks like a URL
                if (url.match(/^https?:\/\//i) || url.match(/^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}/)) {
                    if (!url.match(/^https?:\/\//i)) {
                        url = 'https://' + url;
                    }
                } else {
                    // Treat as search query - use selected search engine
                    const engine = searchEngines[getSearchEngine()];
                    url = engine.url + encodeURIComponent(url);
                }
                return url;
            }

            function createTab(url = 'jq://newtab/', title = 'New Tab') {
                // Normalize jq:// URLs to always have trailing slash
                if (url.startsWith('jq://') && !url.endsWith('/')) {
                    url = url + '/';
                }
                const tabId = `tab-${++tabIdCounter}`;
                const tab = {
                    id: tabId,
                    url: url,
                    title: title,
                    history: [url],
                    historyIndex: 0,
                    canGoBack: false,
                    canGoForward: false
                };
                tabs.push(tab);

                // Create tab element
                const tabElement = document.createElement('div');
                tabElement.className = 'tab';
                tabElement.dataset.tabId = tabId;
                tabElement.innerHTML = `
                    <span class="tab-title">${title}</span>
                    <button class="tab-close" onclick="closeTab('${tabId}')" title="Close tab">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                tabElement.addEventListener('click', (e) => {
                    if (!e.target.closest('.tab-close')) {
                        switchToTab(tabId);
                    }
                });

                // Insert before new tab button
                tabBar.insertBefore(tabElement, newTabButton);

                // Create tab content
                const contentElement = document.createElement('div');
                contentElement.className = 'tab-content';
                contentElement.id = `content-${tabId}`;
                contentElement.dataset.tabId = tabId;
                browserContent.appendChild(contentElement);

                // Load content
                loadTabContent(tabId, url);

                // Make it active
                switchToTab(tabId);

                return tabId;
            }

            function closeTab(tabId) {
                const tabIndex = tabs.findIndex(t => t.id === tabId);
                if (tabIndex === -1) return;

                tabs.splice(tabIndex, 1);

                // Remove tab element
                const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                if (tabElement) tabElement.remove();

                // Remove content
                const contentElement = document.getElementById(`content-${tabId}`);
                if (contentElement) contentElement.remove();

                // Switch to another tab if this was active
                if (activeTabId === tabId) {
                    if (tabs.length > 0) {
                        switchToTab(tabs[tabs.length - 1].id);
                    } else {
                        activeTabId = null;
                        createTab();
                    }
                }
            }

            function switchToTab(tabId) {
                activeTabId = tabId;

                // Update tab appearance
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const activeTabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                if (activeTabElement) activeTabElement.classList.add('active');

                // Update content visibility
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                const activeContent = document.getElementById(`content-${tabId}`);
                if (activeContent) activeContent.classList.add('active');

                // Update URL bar
                const tab = tabs.find(t => t.id === tabId);
                if (tab) {
                    urlInput.value = tab.url;
                    updateNavigationButtons(tab);
                } else {
                    updateNavigationButtons(null);
                }
                
                // Update bookmark button if function exists
                if (typeof updateBookmarkButton === 'function') {
                    setTimeout(updateBookmarkButton, 50);
                }
            }

            async function loadTabContent(tabId, url, addToHistory = true) {
                const tab = tabs.find(t => t.id === tabId);
                if (!tab) return;

                const contentElement = document.getElementById(`content-${tabId}`);
                if (!contentElement) return;

                // Handle special URLs - normalize jq:// URLs to always have trailing slash
                if (url.startsWith('jq://') && !url.endsWith('/')) {
                    url = url + '/';
                }
                if (url.startsWith('jq://')) {
                    handleSpecialUrl(tabId, url);
                    if (addToHistory && tab.history[tab.history.length - 1] !== url) {
                        tab.history = tab.history.slice(0, tab.historyIndex + 1);
                        tab.history.push(url);
                        tab.historyIndex = tab.history.length - 1;
                    }
                    updateNavigationButtons(tab);
                    return;
                }

                // Normalize URL before processing
                const normalizedUrl = normalizeUrl(url);
                const sessionId = getDeviceSessionId();
                
                // Ensure session exists and get proxied URL with proper shuffling
                let proxiedUrl;
                try {
                    const response = await fetch(`${basePath}/getproxiedurl?id=${encodeURIComponent(sessionId)}&url=${encodeURIComponent(normalizedUrl)}`);
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    const data = await response.json();
                    proxiedUrl = data.proxiedUrl || `${basePath}/${sessionId}/${normalizedUrl}`;
                } catch (e) {
                    console.error('Failed to get proxied URL:', e);
                    // Fallback: ensure session and use direct URL
                    try {
                        await fetch(`${basePath}/ensuresession?id=${encodeURIComponent(sessionId)}`);
                    } catch (e2) {
                        console.error('Failed to ensure session:', e2);
                    }
                    proxiedUrl = `${basePath}/${sessionId}/${normalizedUrl}`;
                }

                // Ensure shuffler is ready (fetch shuffle dict after session exists)
                if (!_shuffler) {
                    await getShuffler();
                }
                
                // Store actual URL in tab (always the real URL, not shuffled)
                tab.url = normalizedUrl;
                if (tabId === activeTabId) {
                    urlInput.value = normalizedUrl;
                }

                // Clear any wallpaper background from newtab
                contentElement.style.backgroundImage = '';
                contentElement.innerHTML = `<iframe src="${proxiedUrl}" style="width: 100%; height: 100%; border: none;"></iframe>`;
                
                // Update tab title from iframe and intercept window.open/close
                const iframe = contentElement.querySelector('iframe');
                if (iframe) {
                    // Track iframe URL changes for redirects
                    let lastUrl = normalizedUrl;
                    
                    iframe.onload = () => {
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            const iframeWindow = iframe.contentWindow;
                            
                            // Try to get current URL from iframe (for redirect tracking)
                            try {
                                const currentUrl = iframeWindow.location.href;
                                // Use extractRealUrl to properly unshuffle the proxy URL
                                const destUrl = extractRealUrl(currentUrl);
                                
                                if (destUrl && destUrl !== lastUrl && destUrl !== normalizedUrl && tabId === activeTabId) {
                                    lastUrl = destUrl;
                                    urlInput.value = destUrl;
                                    tab.url = destUrl;
                                    // Add redirect to history
                                    if (addToHistory && tab.history[tab.history.length - 1] !== destUrl) {
                                        tab.history = tab.history.slice(0, tab.historyIndex + 1);
                                        tab.history.push(destUrl);
                                        tab.historyIndex = tab.history.length - 1;
                                        updateNavigationButtons(tab);
                                    }
                                }
                            } catch (e) {
                                // Cross-origin or other error - can't read iframe URL
                            }
                            
                            const title = iframeDoc.title || new URL(normalizedUrl).hostname;
                            updateTabTitle(tabId, title);
                            
                            // Intercept window.open() from proxied content
                            if (iframeWindow && typeof iframeWindow.open === 'function') {
                                try {
                                    const originalOpen = iframeWindow.open;
                                    iframeWindow.open = function(url, target, features) {
                                        // If target is _blank or not specified, open in new tab
                                        if (!target || target === '_blank') {
                                            if (url) {
                                                // Resolve relative URLs
                                                let fullUrl = url;
                                                try {
                                                    fullUrl = new URL(url, normalizedUrl).href;
                                                } catch (e) {
                                                    // If URL parsing fails, try to use as-is
                                                }
                                                // Normalize and open in new tab
                                                const normalized = normalizeUrl(fullUrl);
                                                createTab(normalized);
                                            } else {
                                                // No URL, just open new tab
                                                createTab();
                                            }
                                            return null; // Return null like window.open() does for blocked popups
                                        }
                                        // For other targets, try to use original behavior
                                        try {
                                            return originalOpen.call(this, url, target, features);
                                        } catch (e) {
                                            // If original fails, open in new tab
                                            if (url) {
                                                let fullUrl = url;
                                                try {
                                                    fullUrl = new URL(url, normalizedUrl).href;
                                                } catch (e2) {}
                                                createTab(normalizeUrl(fullUrl));
                                            }
                                            return null;
                                        }
                                    };
                                } catch (e) {
                                    console.warn('Could not override window.open in iframe:', e);
                                }
                            }
                            
                            // Intercept window.close() from proxied content
                            if (iframeWindow && typeof iframeWindow.close === 'function') {
                                try {
                                    const originalClose = iframeWindow.close;
                                    iframeWindow.close = function() {
                                        // Only close if it's not the last tab
                                        if (tabs.length > 1) {
                                            closeTab(tabId);
                                        }
                                        // Don't call original close as it would try to close the iframe
                                    };
                                } catch (e) {
                                    console.warn('Could not override window.close in iframe:', e);
                                }
                            }
                            
                            // Intercept links with target="_blank" to open in new tabs
                            try {
                                const links = iframeDoc.querySelectorAll('a[target="_blank"]');
                                links.forEach(link => {
                                    link.addEventListener('click', (e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        const href = link.getAttribute('href');
                                        if (href) {
                                            // Resolve relative URLs
                                            let fullUrl;
                                            try {
                                                fullUrl = new URL(href, normalizedUrl).href;
                                            } catch (e) {
                                                fullUrl = href;
                                            }
                                            createTab(normalizeUrl(fullUrl));
                                        }
                                    }, true); // Use capture phase
                                });
                                
                                // Also intercept dynamically created links
                                const observer = new MutationObserver((mutations) => {
                                    mutations.forEach((mutation) => {
                                        mutation.addedNodes.forEach((node) => {
                                            if (node.nodeType === 1) { // Element node
                                                if (node.tagName === 'A' && node.getAttribute('target') === '_blank') {
                                                    node.addEventListener('click', (e) => {
                                                        e.preventDefault();
                                                        e.stopPropagation();
                                                        const href = node.getAttribute('href');
                                                        if (href) {
                                                            let fullUrl;
                                                            try {
                                                                fullUrl = new URL(href, normalizedUrl).href;
                                                            } catch (e) {
                                                                fullUrl = href;
                                                            }
                                                            createTab(normalizeUrl(fullUrl));
                                                        }
                                                    }, true);
                                                }
                                                // Also check child links
                                                const childLinks = node.querySelectorAll('a[target="_blank"]');
                                                childLinks.forEach(link => {
                                                    link.addEventListener('click', (e) => {
                                                        e.preventDefault();
                                                        e.stopPropagation();
                                                        const href = link.getAttribute('href');
                                                        if (href) {
                                                            let fullUrl;
                                                            try {
                                                                fullUrl = new URL(href, normalizedUrl).href;
                                                            } catch (e) {
                                                                fullUrl = href;
                                                            }
                                                            createTab(normalizeUrl(fullUrl));
                                                        }
                                                    }, true);
                                                });
                                            }
                                        });
                                    });
                                });
                                observer.observe(iframeDoc.body || iframeDoc.documentElement, {
                                    childList: true,
                                    subtree: true
                                });
                            } catch (e) {
                                console.warn('Could not intercept links in iframe:', e);
                            }
                            
                        } catch (e) {
                            // Cross-origin or other error, use URL hostname
                            try {
                                const urlObj = new URL(normalizedUrl);
                                updateTabTitle(tabId, urlObj.hostname);
                            } catch (e2) {
                                updateTabTitle(tabId, 'Page');
                            }
                        }
                    };
                }
            }

            function handleSpecialUrl(tabId, url) {
                const contentElement = document.getElementById(`content-${tabId}`);
                
                // Clear wallpaper background when navigating away from newtab
                if (url !== 'jq://newtab/') {
                    contentElement.style.backgroundImage = '';
                }
                
                if (url === 'jq://home/') {
                    contentElement.innerHTML = getHomePageHTML();
                    updateTabTitle(tabId, 'Home');
                    initHomePage();
                } else if (url === 'jq://newtab/') {
                    const bg = localStorage.getItem('newTabBackground') || '';
                    if (bg) {
                        contentElement.style.backgroundImage = `url('${bg}')`;
                        contentElement.style.backgroundSize = 'cover';
                        contentElement.style.backgroundPosition = 'center';
                        contentElement.style.backgroundRepeat = 'no-repeat';
                    } else {
                        contentElement.style.backgroundImage = '';
                    }
                    contentElement.innerHTML = getNewTabHTML();
                    updateTabTitle(tabId, 'New Tab');
                } else if (url === 'jq://sessions/') {
                    contentElement.innerHTML = getSessionsPageHTML();
                    updateTabTitle(tabId, 'Sessions');
                    initSessionsPage();
                } else if (url === 'jq://settings/') {
                    contentElement.innerHTML = getSettingsPageHTML();
                    updateTabTitle(tabId, 'Settings');
                    initSettingsPage();
                } else if (url === 'jq://bookmarks/') {
                    contentElement.innerHTML = getBookmarksPageHTML();
                    updateTabTitle(tabId, 'Bookmarks');
                    initBookmarksPage();
                } else if (url === 'jq://history/') {
                    contentElement.innerHTML = getHistoryPageHTML();
                    updateTabTitle(tabId, 'History');
                    initHistoryPage();
                } else if (url === 'jq://downloads/') {
                    contentElement.innerHTML = getDownloadsPageHTML();
                    updateTabTitle(tabId, 'Downloads');
                    initDownloadsPage();
                }
            }

            function getHomePageHTML() {
                return `
                    <div class="home-page">
                        <div class="page-header">
                            <h1>Browser Pages</h1>
                            <p>Access internal browser pages</p>
            </div>
                        <div class="home-grid">
                            <a href="jq://newtab/" class="home-card" data-url="jq://newtab/">
                                <div class="home-card-icon"><i class="fas fa-search"></i></div>
                                <div class="home-card-title">New Tab</div>
                                <div class="home-card-desc">Search and browse the web</div>
                            </a>
                            <a href="jq://sessions/" class="home-card" data-url="jq://sessions/">
                                <div class="home-card-icon"><i class="fas fa-key"></i></div>
                                <div class="home-card-title">Sessions</div>
                                <div class="home-card-desc">Manage your proxy session</div>
                            </a>
                            <a href="jq://settings/" class="home-card" data-url="jq://settings/">
                                <div class="home-card-icon"><i class="fas fa-cog"></i></div>
                                <div class="home-card-title">Settings</div>
                                <div class="home-card-desc">Customize your browser</div>
                            </a>
                            <a href="#" class="home-card" data-url="customize-theme" id="customize-theme-card">
                                <div class="home-card-icon"><i class="fas fa-palette"></i></div>
                                <div class="home-card-title">Customize Theme</div>
                                <div class="home-card-desc">Change theme colors and background</div>
                            </a>
            </div>
                        ${_jqFooterHTML}
        </div>
                `;
            }

            function initHomePage() {
                document.querySelectorAll('.home-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        e.preventDefault();
                        const url = card.dataset.url;
                        if (url === 'customize-theme') {
                            showCustomizeThemeModal();
                        } else if (url) {
                            createTab(url);
                        }
                    });
                });
            }
            
            function showCustomizeThemeModal() {
                const currentThemeColor = localStorage.getItem('themeColor') || '#1a73e8';
                const currentThemeColorSecondary = localStorage.getItem('themeColorSecondary') || '#34a853';
                const currentBackground = localStorage.getItem('newTabBackground') || '';
                const uploadedBackground = localStorage.getItem('uploadedBackground') || '';
                
                // Generate wallpaper gallery HTML with refined design
                const wallpaperBaseUrl = 'https://jimmyqrg.github.io/unlinewize/assets/wallpapers';
                const wallpaperNumbers = Array.from({length: 50}, (_, i) => i + 1);
                const wallpaperGallery = wallpaperNumbers.map(num => {
                    const isSelected = currentBackground.includes(`wallpapers/${num}.jpg`) || currentBackground.includes(`/wallpapers/${num}.jpg`);
                    return `
                        <div class="wallpaper-thumb" data-wallpaper="${num}.jpg" style="
                            width: 140px; 
                            height: 90px; 
                            background-image: url('${wallpaperBaseUrl}/${num}.jpg'); 
                            background-size: cover; 
                            background-position: center; 
                            border: 3px solid ${isSelected ? 'var(--color-primary)' : 'transparent'}; 
                            border-radius: 8px; 
                            cursor: pointer; 
                            position: relative;
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                            box-shadow: ${isSelected ? '0 4px 12px rgba(0,0,0,0.15)' : '0 2px 4px rgba(0,0,0,0.1)'};
                            overflow: hidden;
                        " ${isSelected ? 'data-selected="true"' : ''}>
                            <div style="position: absolute; inset: 0; background: ${isSelected ? 'rgba(0,0,0,0.1)' : 'transparent'}; transition: background 0.3s;"></div>
                            ${isSelected ? '<div style="position: absolute; top: 8px; right: 8px; background: var(--color-primary); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1;"><i class="fas fa-check"></i></div>' : ''}
                        </div>
                    `;
                }).join('');
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 24px; animation: fadeIn 0.2s ease-out;';
                modal.innerHTML = `
                    <div style="
                        background: var(--color-bg-primary); 
                        border-radius: 16px; 
                        max-width: 800px; 
                        width: 100%; 
                        max-height: 90vh; 
                        display: flex;
                        flex-direction: column;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        border: 1px solid var(--color-border);
                        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    ">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 32px 32px 20px; border-bottom: 2px solid var(--color-border-divider); flex-shrink: 0;">
                            <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: var(--color-text-primary); display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-palette" style="color: var(--color-primary);"></i> Customize Theme
                            </h2>
                            <button id="close-modal-button" style="background: none; border: none; color: var(--color-text-icon); cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="overflow-y: auto; flex: 1; padding: 28px 32px 0;">
                        
                        <div style="margin-bottom: 32px;">
                            <label style="display: block; margin-bottom: 16px; font-weight: 500; color: var(--color-text-primary); font-size: 14px;">
                                <i class="fas fa-fill-drip" style="margin-right: 8px; color: var(--color-primary);"></i>Theme Colors
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label for="theme-color-picker" style="display: block; margin-bottom: 8px; font-size: 13px; color: var(--color-text-secondary);">Primary Color</label>
                                    <div style="display: flex; gap: 12px; align-items: center; background: var(--color-bg-tertiary); padding: 12px; border-radius: 8px; border: 1px solid var(--color-border);">
                                        <input type="color" id="theme-color-picker" value="${currentThemeColor}" style="width: 56px; height: 40px; border: 2px solid var(--color-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                        <input type="text" id="theme-color-input" value="${currentThemeColor}" style="flex: 1; padding: 10px; border: 1px solid var(--color-border); border-radius: 8px; font-family: var(--font-family-mono); font-size: 13px; background: var(--color-bg-primary); color: var(--color-text-primary); transition: all 0.2s;">
                                    </div>
                                </div>
                                <div>
                                    <label for="theme-color-secondary-picker" style="display: block; margin-bottom: 8px; font-size: 13px; color: var(--color-text-secondary);">Secondary Color</label>
                                    <div style="display: flex; gap: 12px; align-items: center; background: var(--color-bg-tertiary); padding: 12px; border-radius: 8px; border: 1px solid var(--color-border);">
                                        <input type="color" id="theme-color-secondary-picker" value="${currentThemeColorSecondary}" style="width: 56px; height: 40px; border: 2px solid var(--color-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                        <input type="text" id="theme-color-secondary-input" value="${currentThemeColorSecondary}" style="flex: 1; padding: 10px; border: 1px solid var(--color-border); border-radius: 8px; font-family: var(--font-family-mono); font-size: 13px; background: var(--color-bg-primary); color: var(--color-text-primary); transition: all 0.2s;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 32px;">
                            <label style="display: block; margin-bottom: 12px; font-weight: 500; color: var(--color-text-primary); font-size: 14px;">
                                <i class="fas fa-image" style="margin-right: 8px; color: var(--color-primary);"></i>Wallpaper
                            </label>
                            
                            <div style="margin-bottom: 16px;">
                                <div style="
                                    display: grid; 
                                    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
                                    gap: 16px; 
                                    max-height: 320px; 
                                    overflow-y: auto; 
                                    padding: 16px; 
                                    background: var(--color-bg-tertiary); 
                                    border-radius: 12px;
                                    border: 1px solid var(--color-border);
                                ">
                                    ${wallpaperGallery}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label for="background-upload" style="
                                    display: block;
                                    padding: 20px;
                                    border: 2px dashed var(--color-border);
                                    border-radius: 12px;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    background: var(--color-bg-tertiary);
                                    color: var(--color-text-secondary);
                                " onmouseover="this.style.borderColor='var(--color-primary)'; this.style.background='var(--color-primary-light)'" onmouseout="this.style.borderColor='var(--color-border)'; this.style.background='var(--color-bg-tertiary)'">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 32px; margin-bottom: 8px; display: block; color: var(--color-primary);"></i>
                                    <div style="font-weight: 500; margin-bottom: 4px;">Upload Custom Background</div>
                                    <div style="font-size: 12px; color: var(--color-text-muted);">Click to select an image file</div>
                                    <input type="file" id="background-upload" accept="image/*" style="display: none;">
                                </label>
                                <div id="uploaded-preview" style="display: ${uploadedBackground ? 'block' : 'none'}; margin-top: 12px;">
                                    <div style="position: relative; display: inline-block;">
                                        <img id="uploaded-image-preview" src="${uploadedBackground}" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 2px solid var(--color-primary); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                        <button id="remove-uploaded" style="position: absolute; top: -8px; right: -8px; background: var(--color-error-bg); color: var(--color-error-text); border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                            <i class="fas fa-times" style="font-size: 12px;"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="background-input" value="${currentBackground && !currentBackground.startsWith('data:') ? currentBackground : ''}" placeholder="Or enter image URL" style="flex: 1; padding: 12px; border: 1px solid var(--color-border); border-radius: 8px; background: var(--color-bg-primary); color: var(--color-text-primary); font-size: 14px; transition: all 0.2s;">
                                <button class="button button-secondary" id="clear-background-button" style="white-space: nowrap; padding: 12px 20px;">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end; padding: 20px 32px; border-top: 2px solid var(--color-border-divider); flex-shrink: 0; background: var(--color-bg-primary); border-radius: 0 0 16px 16px;">
                            <button class="button button-secondary" id="cancel-theme-button" style="padding: 12px 24px;">
                                Cancel
                            </button>
                            <button class="button" id="save-theme-button" style="padding: 12px 24px; background: var(--color-primary); color: white; font-weight: 500;">
                                <i class="fas fa-check" style="margin-right: 8px;"></i>Save Changes
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                const colorPicker = modal.querySelector('#theme-color-picker');
                const colorInput = modal.querySelector('#theme-color-input');
                const colorSecondaryPicker = modal.querySelector('#theme-color-secondary-picker');
                const colorSecondaryInput = modal.querySelector('#theme-color-secondary-input');
                const backgroundInput = modal.querySelector('#background-input');
                const clearBackgroundButton = modal.querySelector('#clear-background-button');
                const backgroundUpload = modal.querySelector('#background-upload');
                const uploadedPreview = modal.querySelector('#uploaded-preview');
                const uploadedImagePreview = modal.querySelector('#uploaded-image-preview');
                const removeUploaded = modal.querySelector('#remove-uploaded');
                const closeModalButton = modal.querySelector('#close-modal-button');
                
                // Close modal handlers
                closeModalButton.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                closeModalButton.addEventListener('mouseenter', () => {
                    closeModalButton.style.background = 'var(--color-bg-hover)';
                    closeModalButton.style.color = 'var(--color-text-primary)';
                });
                closeModalButton.addEventListener('mouseleave', () => {
                    closeModalButton.style.background = 'none';
                    closeModalButton.style.color = 'var(--color-text-icon)';
                });
                
                // Primary color handlers
                colorPicker.addEventListener('input', (e) => {
                    colorInput.value = e.target.value;
                });
                
                colorInput.addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                        colorPicker.value = e.target.value;
                    }
                });
                
                // Secondary color handlers
                colorSecondaryPicker.addEventListener('input', (e) => {
                    colorSecondaryInput.value = e.target.value;
                });
                
                colorSecondaryInput.addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                        colorSecondaryPicker.value = e.target.value;
                    }
                });
                
                // Handle file upload
                backgroundUpload.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const base64 = event.target.result;
                            localStorage.setItem('uploadedBackground', base64);
                            uploadedImagePreview.src = base64;
                            uploadedPreview.style.display = 'block';
                            backgroundInput.value = ''; // Clear URL input
                            // Clear wallpaper selection
                            modal.querySelectorAll('.wallpaper-thumb').forEach(t => {
                                t.style.borderColor = 'transparent';
                                t.removeAttribute('data-selected');
                                const check = t.querySelector('div');
                                if (check && check.querySelector('i.fa-check')) check.remove();
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // Remove uploaded image
                removeUploaded.addEventListener('click', () => {
                    localStorage.removeItem('uploadedBackground');
                    uploadedPreview.style.display = 'none';
                    backgroundUpload.value = '';
                });
                
                // Handle wallpaper selection
                modal.querySelectorAll('.wallpaper-thumb').forEach(thumb => {
                    thumb.addEventListener('click', () => {
                        // Remove selection from all thumbs
                        modal.querySelectorAll('.wallpaper-thumb').forEach(t => {
                            t.style.borderColor = 'transparent';
                            t.removeAttribute('data-selected');
                            const overlay = t.querySelector('div[style*="position: absolute; inset"]');
                            if (overlay) overlay.style.background = 'transparent';
                            const check = t.querySelector('div[style*="top: 8px"]');
                            if (check) check.remove();
                        });
                        
                        // Select clicked wallpaper
                        const wallpaper = thumb.dataset.wallpaper;
                        const wallpaperUrl = `${wallpaperBaseUrl}/${wallpaper}`;
                        backgroundInput.value = wallpaperUrl;
                        // Clear uploaded image
                        localStorage.removeItem('uploadedBackground');
                        uploadedPreview.style.display = 'none';
                        backgroundUpload.value = '';
                        
                        thumb.style.borderColor = 'var(--color-primary)';
                        thumb.setAttribute('data-selected', 'true');
                        const overlay = thumb.querySelector('div[style*="position: absolute; inset"]');
                        if (overlay) overlay.style.background = 'rgba(0,0,0,0.1)';
                        thumb.innerHTML = '<div style="position: absolute; inset: 0; background: rgba(0,0,0,0.1); transition: background 0.3s;"></div><div style="position: absolute; top: 8px; right: 8px; background: var(--color-primary); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1;"><i class="fas fa-check"></i></div>';
                    });
                    
                    // Add hover effect
                    thumb.addEventListener('mouseenter', () => {
                        if (!thumb.hasAttribute('data-selected')) {
                            thumb.style.borderColor = 'var(--color-primary)';
                            thumb.style.transform = 'scale(1.05)';
                            const overlay = thumb.querySelector('div[style*="position: absolute; inset"]');
                            if (overlay) overlay.style.background = 'rgba(0,0,0,0.05)';
                        }
                    });
                    thumb.addEventListener('mouseleave', () => {
                        if (!thumb.hasAttribute('data-selected')) {
                            thumb.style.borderColor = 'transparent';
                            thumb.style.transform = 'scale(1)';
                            const overlay = thumb.querySelector('div[style*="position: absolute; inset"]');
                            if (overlay) overlay.style.background = 'transparent';
                        }
                    });
                });
                
                clearBackgroundButton.addEventListener('click', () => {
                    backgroundInput.value = '';
                    localStorage.removeItem('uploadedBackground');
                    uploadedPreview.style.display = 'none';
                    backgroundUpload.value = '';
                    modal.querySelectorAll('.wallpaper-thumb').forEach(t => {
                        t.style.borderColor = 'transparent';
                        t.removeAttribute('data-selected');
                        const overlay = t.querySelector('div[style*="position: absolute; inset"]');
                        if (overlay) overlay.style.background = 'transparent';
                        const check = t.querySelector('div[style*="top: 8px"]');
                        if (check) check.remove();
                    });
                });
                
                modal.querySelector('#save-theme-button').addEventListener('click', () => {
                    const themeColor = colorInput.value;
                    const themeColorSecondary = colorSecondaryInput.value;
                    const background = backgroundInput.value.trim();
                    const uploadedBg = localStorage.getItem('uploadedBackground') || '';
                    
                    if (/^#[0-9A-F]{6}$/i.test(themeColor) && /^#[0-9A-F]{6}$/i.test(themeColorSecondary)) {
                        localStorage.setItem('themeColor', themeColor);
                        localStorage.setItem('themeColorSecondary', themeColorSecondary);
                        
                        // Priority: uploaded image > URL input > nothing
                        if (uploadedBg) {
                            localStorage.setItem('newTabBackground', uploadedBg);
                        } else if (background) {
                            localStorage.setItem('newTabBackground', background);
                        } else {
                            localStorage.removeItem('newTabBackground');
                        }
                        
                        // Apply theme colors to CSS variables
                        document.documentElement.style.setProperty('--color-primary', themeColor);
                        document.documentElement.style.setProperty('--color-link', themeColor);
                        document.documentElement.style.setProperty('--color-primary-secondary', themeColorSecondary);
                        
                        // Update new tab background if we're on it
                        if (activeTabId) {
                            const tab = tabs.find(t => t.id === activeTabId);
                            if (tab && tab.url === 'jq://newtab/') {
                                loadTabContent(activeTabId, 'jq://newtab/');
                            }
                        }
                        
                        document.body.removeChild(modal);
                    } else {
                        alert('Please enter valid hex colors for both primary and secondary colors (e.g., #1a73e8)');
                    }
                });
                
                modal.querySelector('#cancel-theme-button').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            }

            function getNewTabHTML() {
                const pageTitle = localStorage.getItem('pageTitle') || 'Unlinewize';
                const savedFavicon = localStorage.getItem('faviconData') || 'favicon.png';
                return `
                    <div class="new-tab-content">
                        <div class="new-tab-logo-container">
                            <img class="favicon-logo" src="${savedFavicon}" alt="${pageTitle}" />
            </div>
                        <div class="new-tab-title">${pageTitle}</div>
                        <div class="new-tab-subtitle">Fast, secure web browsing</div>
                        <div class="search-box">
                            <div class="search-input-wrapper">
                                <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                                <input type="text" class="search-input" id="newtab-search-input" placeholder="Search or type a URL" autocomplete="off" />
                </div>
                            <div class="search-buttons">
                                <button class="search-button" id="newtab-go-button">Open</button>
                                <button class="search-button" id="newtab-lucky-button">Search</button>
            </div>
        </div>
                        <div class="generate-link-section">
                            <button class="generate-link-button" id="newtab-generate-link-button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
                                </svg>
                                Generate never-expire link
                            </button>
                            <div class="link-result" id="newtab-link-result" style="display: none;">
                                <div class="link-result-label">Never-expire link:</div>
                                <div class="link-display">
                                    <div class="link-url" id="newtab-link-url"></div>
                                    <button class="copy-button" id="newtab-copy-button" disabled>Copy</button>
    </div>
    </div>
                            <div class="error-message" id="newtab-error-message"></div>
                            <div class="loading" id="newtab-loading">
                                <span class="spinner"></span>
                                Creating session...
            </div>
        </div>
                        ${_jqFooterHTML}
    </div>
                `;
            }

            function getSessionsPageHTML() {
                const sessionId = getDeviceSessionId();
                return `
                    <div class="sessions-page">
                        <div class="page-header">
                            <h1>Session Management</h1>
                            <p>Manage your proxy session ID, your data is stored in the session ID, you can transfer the data between devices by sharing the session ID.</p>
                        </div>
                        <div class="sessions-section">
                            <h2>Current Session</h2>
                            <div class="session-id-display" id="current-session-id">${sessionId}</div>
                            <div class="form-group">
                                <label for="new-session-id">Change Session ID</label>
                                <input type="text" id="new-session-id" placeholder="Enter new session ID" />
                            </div>
                            <div class="button-group">
                                <button class="button" id="update-session-button">Update Session ID</button>
                                <button class="button button-secondary" id="generate-session-button">Generate New Session ID</button>
                            </div>
                            <div class="success-message" id="session-success-message"></div>
                            <div class="error-message" id="session-error-message"></div>
                        </div>
                        ${_jqFooterHTML}
                    </div>
                `;
            }

            function getSettingsPageHTML() {
                const pageTitle = localStorage.getItem('pageTitle') || 'Unlinewize';
                const faviconData = localStorage.getItem('faviconData');
                return `
                    <div class="settings-page">
                        <div class="page-header">
                            <h1>Settings</h1>
                            <p>Customize your browser experience</p>
                        </div>
                        <div class="settings-section">
                            <h2>Page Title</h2>
                            <div class="form-group">
                                <label for="page-title-input">Current Title</label>
                                <input type="text" id="page-title-input" value="${pageTitle}" placeholder="Enter page title" />
                            </div>
                            <button class="button" id="save-title-button">Save Title</button>
                        </div>
                        <div class="settings-section">
                            <h2>Favicon</h2>
                            <div class="form-group">
                                <label for="favicon-input">Upload Favicon</label>
                                <input type="file" id="favicon-input" accept="image/*" />
                                ${faviconData ? `<img src="${faviconData}" class="preview-favicon" id="favicon-preview" />` : ''}
                            </div>
                            <button class="button" id="save-favicon-button">Save Favicon</button>
                        </div>
                        <div class="settings-section">
                            <h2>Search Engine</h2>
                            <div class="form-group">
                                <label for="search-engine-select">Default Search Engine</label>
                                <select id="search-engine-select" class="form-control">
                                    ${Object.entries(searchEngines).map(([key, engine]) => 
                                        `<option value="${key}" ${getSearchEngine() === key ? 'selected' : ''}>${engine.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <button class="button" id="save-search-engine-button">Save</button>
                        </div>
                        <div class="settings-section">
                            <h2><i class="fas fa-shield-alt"></i> Privacy & Security</h2>
                            <p style="color: var(--color-text-secondary); margin-bottom: 16px;">Manage your privacy and security settings</p>
                            <div class="action-buttons">
                                <button class="button button-secondary" id="settings-clear-cookies-button"><i class="fas fa-cookie"></i> Clear Cookies</button>
                                <button class="button button-secondary" id="settings-clear-cache-button"><i class="fas fa-broom"></i> Clear Cache</button>
                                <button class="button button-secondary" id="settings-clear-storage-button"><i class="fas fa-database"></i> Clear Storage</button>
                                <button class="button button-secondary" id="settings-clear-all-button"><i class="fas fa-trash-alt"></i> Clear All Data</button>
                            </div>
                            <div style="margin-top: 16px;">
                                <button class="button button-secondary" id="settings-view-cookies-button"><i class="fas fa-eye"></i> View Cookies</button>
                                <div id="settings-cookies-display" style="margin-top: 16px;"></div>
                            </div>
                            <div class="form-group" style="margin-top: 20px;">
                                <label for="settings-user-agent-input">Custom User Agent</label>
                                <input type="text" id="settings-user-agent-input" class="form-control" 
                                    value="${localStorage.getItem('userAgent') || navigator.userAgent}" 
                                    placeholder="User agent string" />
                            </div>
                            <button class="button" id="settings-save-user-agent-button">Save User Agent</button>
                        </div>
                        <div class="settings-section">
                            <h2><i class="fas fa-chart-bar"></i> Statistics</h2>
                            <p style="color: var(--color-text-secondary); margin-bottom: 16px;">Your browsing statistics</p>
                            ${(() => {
                                const stats = getStats();
                                const daysSinceStart = Math.floor((Date.now() - stats.startDate) / (1000 * 60 * 60 * 24));
                                return `
                                    <div class="stats-grid" style="margin-top: 16px;">
                                        <div class="stat-card">
                                            <div class="stat-value">${stats.sitesVisited}</div>
                                            <div class="stat-label">Sites Visited</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-value">${getHistory().length}</div>
                                            <div class="stat-label">History Entries</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-value">${getBookmarks().length}</div>
                                            <div class="stat-label">Bookmarks</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-value">${daysSinceStart}</div>
                                            <div class="stat-label">Days Active</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 24px;">
                                        <h3 style="font-size: 16px; margin-bottom: 12px;">Most Visited Sites</h3>
                                        ${(() => {
                                            const history = getHistory();
                                            const siteCounts = {};
                                            history.forEach(item => {
                                                try {
                                                    const url = new URL(item.url);
                                                    const domain = url.hostname.replace('www.', '');
                                                    siteCounts[domain] = (siteCounts[domain] || 0) + 1;
                                                } catch (e) {}
                                            });
                                            const mostVisited = Object.entries(siteCounts)
                                                .sort((a, b) => b[1] - a[1])
                                                .slice(0, 10);
                                            if (mostVisited.length === 0) {
                                                return '<p style="color: var(--color-text-secondary);">No sites visited yet.</p>';
                                            }
                                            return '<table class="data-table"><thead><tr><th>Site</th><th>Visits</th><th>Action</th></tr></thead><tbody>' +
                                                mostVisited.map(([domain, count]) => 
                                                    `<tr><td>${domain}</td><td>${count}</td><td><button class="button button-secondary" onclick="createTab('https://${domain}')"><i class="fas fa-external-link-alt"></i></button></td></tr>`
                                                ).join('') +
                                                '</tbody></table>';
                                        })()}
                                    </div>
                                    <div style="margin-top: 24px;">
                                        <button class="button button-secondary" id="clear-statistics-button"><i class="fas fa-trash-alt"></i> Clear Statistics</button>
                                    </div>
                                `;
                            })()}
                        </div>
                        <div class="settings-section">
                            <h2>Reset Settings</h2>
                            <p style="color: var(--color-text-secondary); margin-bottom: 16px;">Reset all settings to their default values.</p>
                            <button class="button button-secondary" id="reset-settings-button">Reset All Settings</button>
                        </div>
                        <div class="success-message" id="settings-success-message"></div>
                        <div class="error-message" id="settings-error-message"></div>
                        ${_jqFooterHTML}
    </div>
                `;
            }

            // New Page HTML Generators
            function getBookmarksPageHTML() {
                const bookmarks = getBookmarks();
                return `
                    <div class="feature-page">
                        <div class="page-header">
                            <h1><i class="fas fa-bookmark"></i> Bookmarks</h1>
                            <p>Manage your saved bookmarks</p>
                        </div>
                        <div class="action-buttons">
                            <button class="button" id="bookmarks-import-button"><i class="fas fa-upload"></i> Import</button>
                            <button class="button button-secondary" id="bookmarks-export-button"><i class="fas fa-download"></i> Export</button>
                        </div>
                        <div class="settings-section" style="margin-top: 24px;">
                            <h2>Your Bookmarks (${bookmarks.length})</h2>
                            ${bookmarks.length === 0 ? 
                                '<p style="color: var(--color-text-secondary); padding: 24px; text-align: center;">No bookmarks yet. Click the star icon in the address bar to bookmark pages.</p>' :
                                `<table class="data-table">
            <thead>
                <tr>
                                            <th>Title</th>
                                            <th>URL</th>
                                            <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                                        ${bookmarks.map(bookmark => `
                                            <tr>
                                                <td>${bookmark.title}</td>
                                                <td><a href="${bookmark.url}" style="color: var(--color-link);">${bookmark.url}</a></td>
                                                <td>
                                                    <button class="button button-secondary" onclick="openBookmark('${bookmark.url}')"><i class="fas fa-external-link-alt"></i></button>
                                                    <button class="button button-secondary" onclick="deleteBookmark('${bookmark.url}')"><i class="fas fa-trash"></i></button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>`
                            }
                        </div>
                        ${_jqFooterHTML}
                    </div>
                `;
            }

            function getHistoryPageHTML() {
                const history = getHistory();
                const grouped = history.reduce((acc, item) => {
                    const date = new Date(item.timestamp).toDateString();
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(item);
                    return acc;
                }, {});
                
                return `
                    <div class="feature-page">
                        <div class="page-header">
                            <h1><i class="fas fa-history"></i> History</h1>
                            <p>Your browsing history (${history.length} entries)</p>
                        </div>
                        <div class="action-buttons">
                            <button class="button button-secondary" id="clear-history-button"><i class="fas fa-trash"></i> Clear History</button>
                            <input type="text" id="history-search" placeholder="Search history..." class="form-control" style="max-width: 300px; margin-left: auto;">
                        </div>
                        <div class="settings-section" style="margin-top: 24px;">
                            ${history.length === 0 ? 
                                '<p style="color: var(--color-text-secondary); padding: 24px; text-align: center;">No history yet.</p>' :
                                Object.entries(grouped).reverse().map(([date, items]) => `
                                    <h3 style="margin-top: 24px; margin-bottom: 12px;">${date}</h3>
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Title</th>
                                                <th>URL</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${items.reverse().map(item => `
                                                <tr>
                                                    <td>${new Date(item.timestamp).toLocaleTimeString()}</td>
                                                    <td>${item.title}</td>
                                                    <td><a href="${item.url}" style="color: var(--color-link);">${item.url}</a></td>
                                                    <td>
                                                        <button class="button button-secondary" onclick="openHistoryItem('${item.url}')" title="Open"><i class="fas fa-external-link-alt"></i></button>
                                                        <button class="button button-secondary" onclick="deleteHistoryItem('${item.url}', ${item.timestamp})" title="Delete" style="margin-left: 8px;"><i class="fas fa-trash"></i></button>
                                                    </td>
                                                </tr>
                                            `).join('')}
            </tbody>
        </table>
                                `).join('')
                            }
    </div>
                        ${_jqFooterHTML}
                    </div>
                `;
            }

            function getDownloadsPageHTML() {
                const downloads = getDownloads();
                return `
                    <div class="feature-page">
                        <div class="page-header">
                            <h1><i class="fas fa-download"></i> Downloads</h1>
                            <p>Your download history</p>
                        </div>
                        <div class="settings-section" style="margin-top: 24px;">
                            ${downloads.length === 0 ? 
                                '<p style="color: var(--color-text-secondary); padding: 24px; text-align: center;">No downloads yet.</p>' :
                                `<table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Filename</th>
                                            <th>URL</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${downloads.reverse().map(download => `
                                            <tr>
                                                <td>${download.filename}</td>
                                                <td><a href="${download.url}" style="color: var(--color-link);">${download.url}</a></td>
                                                <td>${new Date(download.timestamp).toLocaleString()}</td>
                                                <td><span style="color: var(--color-success);">${download.status}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>`
                            }
                        </div>
                        ${_jqFooterHTML}
                    </div>
                `;
            }

            function getPrivacyPageHTML() {
                return `
                    <div class="feature-page">
                        <div class="page-header">
                            <h1><i class="fas fa-shield-alt"></i> Privacy & Security</h1>
                            <p>Manage your privacy and security settings</p>
                        </div>
                        <div class="settings-section">
                            <h2>Clear Browsing Data</h2>
                            <p style="color: var(--color-text-secondary); margin-bottom: 16px;">Remove browsing data from this browser</p>
                            <div class="action-buttons">
                                <button class="button button-secondary" id="clear-cookies-button"><i class="fas fa-cookie"></i> Clear Cookies</button>
                                <button class="button button-secondary" id="clear-cache-button"><i class="fas fa-broom"></i> Clear Cache</button>
                                <button class="button button-secondary" id="clear-storage-button"><i class="fas fa-database"></i> Clear Storage</button>
                                <button class="button button-secondary" id="clear-all-button"><i class="fas fa-trash-alt"></i> Clear All Data</button>
                            </div>
                        </div>
                        <div class="settings-section">
                            <h2>Cookie Manager</h2>
                            <p style="color: var(--color-text-secondary); margin-bottom: 16px;">View and manage cookies</p>
                            <button class="button" id="view-cookies-button"><i class="fas fa-eye"></i> View Cookies</button>
                            <div id="cookies-display" style="margin-top: 16px;"></div>
                        </div>
                        <div class="settings-section">
                            <h2>User Agent</h2>
                            <div class="form-group">
                                <label for="user-agent-input">Custom User Agent</label>
                                <input type="text" id="user-agent-input" class="form-control" 
                                    value="${localStorage.getItem('userAgent') || navigator.userAgent}" 
                                    placeholder="User agent string" />
                            </div>
                            <button class="button" id="save-user-agent-button">Save User Agent</button>
                        </div>
                        ${_jqFooterHTML}
                    </div>
                `;
            }

            function getStatsPageHTML() {
                const stats = getStats();
                const daysSinceStart = Math.floor((Date.now() - stats.startDate) / (1000 * 60 * 60 * 24));
                return `
                    <div class="feature-page">
                        <div class="page-header">
                            <h1><i class="fas fa-chart-bar"></i> Statistics</h1>
                            <p>Your browsing statistics</p>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${stats.sitesVisited}</div>
                                <div class="stat-label">Sites Visited</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${getHistory().length}</div>
                                <div class="stat-label">History Entries</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${getBookmarks().length}</div>
                                <div class="stat-label">Bookmarks</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${daysSinceStart}</div>
                                <div class="stat-label">Days Active</div>
                            </div>
                        </div>
                        ${_jqFooterHTML}
                    </div>
                `;
            }

            function getDevToolsHTML() {
                return `
                    <div class="devtools-panel" id="devtools-panel">
                        <div class="devtools-header">
                            <div class="devtools-tabs">
                                <button class="devtools-tab active" data-tab="console">Console</button>
                                <button class="devtools-tab" data-tab="network">Network</button>
                                <button class="devtools-tab" data-tab="storage">Storage</button>
                                <button class="devtools-tab" data-tab="source">Source</button>
                            </div>
                            <button class="devtools-close" id="devtools-close"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="devtools-content">
                            <div id="devtools-console" class="devtools-tab-content active">
                                <h3>Console</h3>
                                <p style="color: var(--color-text-secondary);">Console output will appear here</p>
                            </div>
                            <div id="devtools-network" class="devtools-tab-content" style="display: none;">
                                <h3>Network Requests</h3>
                                <table class="network-table">
                                    <thead>
                                        <tr>
                                            <th>Method</th>
                                            <th>URL</th>
                                            <th>Status</th>
                                            <th>Time</th>
                                        </tr>
                                    </thead>
                                    <tbody id="network-table-body">
                                        <tr><td colspan="4" style="text-align: center; color: var(--color-text-secondary);">No requests yet</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="devtools-storage" class="devtools-tab-content" style="display: none;">
                                <h3>Local Storage</h3>
                                <div id="storage-display"></div>
                            </div>
                            <div id="devtools-source" class="devtools-tab-content" style="display: none;">
                                <h3>Page Source</h3>
                                <div id="source-display" style="font-family: var(--font-family-mono); font-size: 12px; white-space: pre-wrap; background: var(--color-bg-secondary); padding: 16px; border-radius: 4px; overflow: auto; max-height: 600px;"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function initSessionsPage() {
                const updateButton = document.getElementById('update-session-button');
                const generateButton = document.getElementById('generate-session-button');
                const newSessionIdInput = document.getElementById('new-session-id');
                const successMsg = document.getElementById('session-success-message');
                const errorMsg = document.getElementById('session-error-message');

                updateButton?.addEventListener('click', () => {
                    const newId = newSessionIdInput.value.trim();
                    if (!newId) {
                        showMessage(errorMsg, 'Please enter a session ID', 'error');
                        return;
                    }
                    setDeviceSessionId(newId);
                    showMessage(successMsg, 'Session ID updated successfully', 'success');
                    setTimeout(() => {
                        document.getElementById('current-session-id').textContent = newId;
                        newSessionIdInput.value = '';
                    }, 500);
                });

                generateButton?.addEventListener('click', () => {
                    const newId = generateSessionId();
                    setDeviceSessionId(newId);
                    newSessionIdInput.value = newId;
                    document.getElementById('current-session-id').textContent = newId;
                    showMessage(successMsg, 'New session ID generated', 'success');
                });
            }

            function initSettingsPage() {
                const saveTitleButton = document.getElementById('save-title-button');
                const saveFaviconButton = document.getElementById('save-favicon-button');
                const resetButton = document.getElementById('reset-settings-button');
                const titleInput = document.getElementById('page-title-input');
                const faviconInput = document.getElementById('favicon-input');
                const successMsg = document.getElementById('settings-success-message');
                const errorMsg = document.getElementById('settings-error-message');

                saveTitleButton?.addEventListener('click', () => {
                    const title = titleInput.value.trim() || 'Unlinewize';
                    localStorage.setItem('pageTitle', title);
                    const titleElement = document.getElementById('page-title');
                    if (titleElement) {
                        titleElement.textContent = title;
                    }
                    // Update all new tab pages
                    document.querySelectorAll('.new-tab-title').forEach(el => {
                        el.textContent = title;
                    });
                    showMessage(successMsg, 'Title saved successfully', 'success');
                });

                saveFaviconButton?.addEventListener('click', () => {
                    const file = faviconInput.files[0];
                    if (!file) {
                        showMessage(errorMsg, 'Please select an image file', 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const faviconData = e.target.result;
                        localStorage.setItem('faviconData', faviconData);
                        const favicon = document.getElementById('favicon');
                        if (favicon) {
                            favicon.href = faviconData;
                        }
                        const preview = document.getElementById('favicon-preview');
                        if (preview) {
                            preview.src = faviconData;
                            preview.style.display = 'block';
                        } else {
                            const img = document.createElement('img');
                            img.src = faviconData;
                            img.className = 'preview-favicon';
                            img.id = 'favicon-preview';
                            faviconInput.parentElement.appendChild(img);
                        }
                        showMessage(successMsg, 'Favicon saved successfully', 'success');
                    };
                    reader.readAsDataURL(file);
                });

                resetButton?.addEventListener('click', () => {
                    // Remove saved settings from localStorage
                    localStorage.removeItem('pageTitle');
                    localStorage.removeItem('faviconData');
                    
                    // Reset to default values
                    const defaultTitle = 'Unlinewize';
                    const defaultFavicon = 'favicon.png';
                    
                    // Update input fields
                    if (titleInput) {
                        titleInput.value = defaultTitle;
                    }
                    
                    // Clear favicon input and preview
                    if (faviconInput) {
                        faviconInput.value = '';
                    }
                    const preview = document.getElementById('favicon-preview');
                    if (preview) {
                        preview.remove();
                    }
                    
                    // Update page title
                    const titleElement = document.getElementById('page-title');
                    if (titleElement) {
                        titleElement.textContent = defaultTitle;
                    }
                    
                    // Update favicon
                    const favicon = document.getElementById('favicon');
                    if (favicon) {
                        favicon.href = defaultFavicon;
                    }
                    
                    // Update all new tab pages
                    document.querySelectorAll('.new-tab-title').forEach(el => {
                        el.textContent = defaultTitle;
                    });
                    
                    // Update favicon in new tab pages
                    document.querySelectorAll('.favicon-logo').forEach(el => {
                        el.src = defaultFavicon;
                    });
                    
                    showMessage(successMsg, 'Settings reset to defaults successfully', 'success');
                });
            }

            function showMessage(element, text, type) {
                if (!element) return;
                element.textContent = text;
                element.classList.add('active');
                setTimeout(() => element.classList.remove('active'), 3000);
            }

            function updateTabTitle(tabId, title) {
                const tab = tabs.find(t => t.id === tabId);
                if (tab) {
                    tab.title = title;
                    const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                    if (tabElement) {
                        const titleElement = tabElement.querySelector('.tab-title');
                        if (titleElement) titleElement.textContent = title;
                    }
                }
            }

            function updateNavigationButtons(tab) {
                if (!tab) {
                    backButton.disabled = true;
                    forwardButton.disabled = true;
                    return;
                }
                tab.canGoBack = tab.historyIndex > 0;
                tab.canGoForward = tab.historyIndex < tab.history.length - 1;
                backButton.disabled = !tab.canGoBack;
                forwardButton.disabled = !tab.canGoForward;
            }
            
            function goBack() {
                if (!activeTabId) return;
                const tab = tabs.find(t => t.id === activeTabId);
                if (!tab || tab.historyIndex <= 0) return;
                
                tab.historyIndex--;
                const url = tab.history[tab.historyIndex];
                tab.url = url;
                urlInput.value = url;
                loadTabContent(activeTabId, url, false); // false = don't add to history
                updateNavigationButtons(tab);
            }
            
            function goForward() {
                if (!activeTabId) return;
                const tab = tabs.find(t => t.id === activeTabId);
                if (!tab || tab.historyIndex >= tab.history.length - 1) return;
                
                tab.historyIndex++;
                const url = tab.history[tab.historyIndex];
                tab.url = url;
                urlInput.value = url;
                loadTabContent(activeTabId, url, false); // false = don't add to history
                updateNavigationButtons(tab);
            }

            function navigateToUrl(url, addToHistory = true) {
                if (!activeTabId) return;
                const tab = tabs.find(t => t.id === activeTabId);
                if (!tab) return;

                // Normalize URL - add trailing slash for jq:// URLs, normalize others
                let finalUrl;
                if (url.startsWith('jq://')) {
                    finalUrl = url.endsWith('/') ? url : url + '/';
                } else {
                    finalUrl = normalizeUrl(url);
                }
                tab.url = finalUrl;
                urlInput.value = finalUrl;
                
                // Add to history if this is a new navigation (not back/forward)
                if (addToHistory) {
                    // Remove any forward history
                    tab.history = tab.history.slice(0, tab.historyIndex + 1);
                    // Add new URL
                    tab.history.push(finalUrl);
                    tab.historyIndex = tab.history.length - 1;
                }
                
                loadTabContent(activeTabId, finalUrl, addToHistory);
                updateNavigationButtons(tab);
            }

            // Initialize new tab page handlers
            function initNewTabHandlers(contentElement) {
                const searchInput = contentElement.querySelector('#newtab-search-input');
                const goButton = contentElement.querySelector('#newtab-go-button');
                const luckyButton = contentElement.querySelector('#newtab-lucky-button');
                const generateButton = contentElement.querySelector('#newtab-generate-link-button');
                const copyButton = contentElement.querySelector('#newtab-copy-button');

                function handleNavigate() {
                    const url = searchInput.value.trim();
                    if (!url) return;
                    const normalized = normalizeUrl(url);
                    if (activeTabId) {
                        loadTabContent(activeTabId, normalized);
                    }
                }

                // Auto-focus the search input when newtab is opened
                if (searchInput) {
                    setTimeout(() => searchInput.focus(), 50);
                }

                goButton?.addEventListener('click', handleNavigate);
                searchInput?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleNavigate();
                });

                luckyButton?.addEventListener('click', () => {
                    const url = searchInput.value.trim();
                    if (!url) return;
                    if (activeTabId) {
                        loadTabContent(activeTabId, 'https://www.bing.com/search?q=' + encodeURIComponent(url));
                    }
                });

                generateButton?.addEventListener('click', async () => {
                    const url = searchInput.value.trim();
                    if (!url) return;
                    const normalized = normalizeUrl(url);
                    try {
                        const response = await fetch(`${basePath}/generatelink?url=${encodeURIComponent(normalized)}`);
                        const data = await response.json();
                        if (data.url) {
                            const linkResult = contentElement.querySelector('#newtab-link-result');
                            const linkUrl = contentElement.querySelector('#newtab-link-url');
                            const copyBtn = contentElement.querySelector('#newtab-copy-button');
                            if (linkUrl && linkResult && copyBtn) {
                                linkUrl.textContent = data.url;
                                linkResult.style.display = 'block';
                                linkResult.classList.add('active');
                                copyBtn.disabled = false;
                            }
                        }
                    } catch (e) {
                        console.error('Failed to generate link', e);
                    }
                });

                copyButton?.addEventListener('click', async () => {
                    const linkUrl = contentElement.querySelector('#newtab-link-url');
                    const linkText = linkUrl?.textContent?.trim();
                    
                    if (!linkText) {
                        console.error('No link to copy');
                        return;
                    }
                    
                    try {
                        // Try modern clipboard API first
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(linkText);
                        } else {
                            // Fallback for older browsers
                            const textArea = document.createElement('textarea');
                            textArea.value = linkText;
                            textArea.style.position = 'fixed';
                            textArea.style.left = '-999999px';
                            textArea.style.top = '-999999px';
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            try {
                                document.execCommand('copy');
                            } catch (err) {
                                console.error('Fallback copy failed:', err);
                            }
                            document.body.removeChild(textArea);
                        }
                        
                        // Update button to show success
                        const originalText = copyButton.textContent;
                        copyButton.textContent = 'Copied!';
                        copyButton.classList.add('copied');
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                            copyButton.classList.remove('copied');
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy link:', err);
                        // Show error to user
                        const originalText = copyButton.textContent;
                        copyButton.textContent = 'Failed!';
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                        }, 2000);
                    }
                });
            }

            // Event listeners
            newTabButton.addEventListener('click', () => createTab());
            urlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    navigateToUrl(urlInput.value);
                }
            });
            clearButton.addEventListener('click', () => {
                urlInput.value = '';
                clearButton.style.display = 'none';
            });
            urlInput.addEventListener('input', () => {
                clearButton.style.display = urlInput.value ? 'block' : 'none';
            });
            refreshButton.addEventListener('click', () => {
                if (activeTabId) {
                    const tab = tabs.find(t => t.id === activeTabId);
                    if (tab) loadTabContent(activeTabId, tab.url, false);
                }
            });
            
            backButton.addEventListener('click', goBack);
            forwardButton.addEventListener('click', goForward);

            // Load saved settings on page load
            function loadSavedSettings() {
                const savedTitle = localStorage.getItem('pageTitle');
                if (savedTitle) {
                    const titleElement = document.getElementById('page-title');
                    if (titleElement) {
                        titleElement.textContent = savedTitle;
                    }
                }
                const savedFavicon = localStorage.getItem('faviconData');
                if (savedFavicon) {
                    const faviconElement = document.getElementById('favicon');
                    if (faviconElement) {
                        faviconElement.href = savedFavicon;
                    }
                }
            }
            
            // ============================================
            // Initialization Functions for New Pages
            // ============================================
            
            function initBookmarksPage() {
                document.getElementById('bookmarks-export-button')?.addEventListener('click', () => {
                    const bookmarks = getBookmarks();
                    const dataStr = JSON.stringify(bookmarks, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'bookmarks.json';
                    link.click();
                });
                
                document.getElementById('bookmarks-import-button')?.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'application/json';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                try {
                                    const imported = JSON.parse(e.target.result);
                                    if (Array.isArray(imported)) {
                                        saveBookmarks(imported);
                                        location.reload();
                                    }
                                } catch (err) {
                                    alert('Invalid bookmarks file');
                                }
                            };
                            reader.readAsText(file);
                        }
                    };
                    input.click();
                });
            }
            
            function initHistoryPage() {
                document.getElementById('clear-history-button')?.addEventListener('click', () => {
                    if (confirm('Clear all browsing history?')) {
                        clearHistory();
                        location.reload();
                    }
                });
                
                document.getElementById('history-search')?.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    document.querySelectorAll('.data-table tbody tr').forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(query) ? '' : 'none';
                    });
                });
            }
            
            function initDownloadsPage() {
                // Downloads page is mostly read-only
            }
            
            function initPrivacyPage() {
                document.getElementById('clear-cookies-button')?.addEventListener('click', () => {
                    if (confirm('Clear all cookies?')) {
                        document.cookie.split(";").forEach(c => {
                            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                        });
                        alert('Cookies cleared');
                    }
                });
                
                document.getElementById('clear-cache-button')?.addEventListener('click', () => {
                    if (confirm('Clear cache?')) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                            alert('Cache cleared');
                        });
                    }
                });
                
                document.getElementById('clear-storage-button')?.addEventListener('click', () => {
                    if (confirm('Clear all localStorage data? This will reset all settings.')) {
                        localStorage.clear();
                        location.reload();
                    }
                });
                
                document.getElementById('clear-all-button')?.addEventListener('click', () => {
                    if (confirm('Clear ALL browsing data? This cannot be undone.')) {
                        localStorage.clear();
                        sessionStorage.clear();
                        document.cookie.split(";").forEach(c => {
                            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                        });
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                        location.reload();
                    }
                });
                
                document.getElementById('view-cookies-button')?.addEventListener('click', () => {
                    const cookies = document.cookie.split(';').map(c => c.trim());
                    const display = document.getElementById('cookies-display');
                    if (cookies.length === 0 || (cookies.length === 1 && cookies[0] === '')) {
                        display.innerHTML = '<p style="color: var(--color-text-secondary);">No cookies found</p>';
                    } else {
                        display.innerHTML = '<table class="data-table"><thead><tr><th>Cookie</th></tr></thead><tbody>' +
                            cookies.map(c => `<tr><td>${c}</td></tr>`).join('') +
                            '</tbody></table>';
                    }
                });
                
                document.getElementById('save-user-agent-button')?.addEventListener('click', () => {
                    const ua = document.getElementById('user-agent-input').value;
                    localStorage.setItem('userAgent', ua);
                    alert('User agent saved');
                });
            }
            
            function initStatsPage() {
                // Stats page is read-only
            }
            
            // Bookmark Bar Functions
            function updateBookmarkBar() {
                const bookmarkBar = document.getElementById('bookmark-bar');
                const bookmarkItems = document.getElementById('bookmark-items');
                if (!bookmarkBar || !bookmarkItems) return;
                
                const bookmarks = getBookmarks();
                const showBar = localStorage.getItem('showBookmarkBar') === 'true';
                bookmarkBar.style.display = showBar ? 'flex' : 'none';
                
                bookmarkItems.innerHTML = bookmarks.slice(0, 10).map(bookmark => `
                    <div class="bookmark-item" onclick="createTab('${bookmark.url}')">
                        <i class="fas fa-bookmark"></i>
                        <span>${bookmark.title}</span>
                    </div>
                `).join('');
            }
            
            // Global functions for onclick handlers
            window.openBookmark = (url) => createTab(url);
            window.deleteBookmark = (url) => {
                removeBookmark(url);
                location.reload();
            };
            window.openHistoryItem = (url) => createTab(url);
            window.deleteHistoryItem = (url, timestamp) => {
                removeHistoryItem(url, timestamp);
                // Reload the history page if we're on it
                if (activeTabId) {
                    const tab = tabs.find(t => t.id === activeTabId);
                    if (tab && tab.url === 'jq://history/') {
                        loadTabContent(activeTabId, 'jq://history/');
                    }
                }
            };
            
            // Menu and UI Event Handlers
            function initUIHandlers() {
                // Menu button - use event delegation to handle dynamically
                document.addEventListener('click', (e) => {
                    const menuButton = document.getElementById('menu-button');
                    const menuDropdown = document.getElementById('menu-dropdown');
                    
                    if (menuButton && (menuButton.contains(e.target) || menuButton === e.target)) {
                        e.stopPropagation();
                        e.preventDefault();
                        if (menuDropdown) {
                            const isVisible = menuDropdown.style.display !== 'none' && menuDropdown.style.display !== '';
                            if (isVisible) {
                                menuDropdown.style.display = 'none';
                            } else {
                                // Position dropdown relative to button
                                const rect = menuButton.getBoundingClientRect();
                                menuDropdown.style.top = (rect.bottom + 4) + 'px';
                                menuDropdown.style.right = (window.innerWidth - rect.right) + 'px';
                                menuDropdown.style.display = 'block';
                            }
                        }
                    } else if (menuDropdown && !menuDropdown.contains(e.target) && !menuButton?.contains(e.target)) {
                        menuDropdown.style.display = 'none';
                    }
                });
                
                // Menu items
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const action = item.dataset.action;
                        const menuDropdown = document.getElementById('menu-dropdown');
                        if (menuDropdown) {
                            menuDropdown.style.display = 'none';
                        }
                        
                        switch(action) {
                            case 'new-tab':
                                createTab();
                                break;
                            case 'bookmarks':
                                createTab('jq://bookmarks/');
                                break;
                            case 'history':
                                createTab('jq://history/');
                                break;
                            case 'settings':
                                createTab('jq://settings/');
                                break;
                            case 'devtools':
                                toggleDevTools();
                                break;
                            case 'theme':
                                const currentTheme = getTheme();
                                setTheme(currentTheme === 'dark' ? 'light' : 'dark');
                                break;
                        }
                    });
                });
                
                // Bookmark button
                const bookmarkButton = document.getElementById('bookmark-button');
                bookmarkButton?.addEventListener('click', () => {
                    const activeTab = tabs.find(t => t.id === activeTabId);
                    if (activeTab && !activeTab.url.startsWith('jq://')) {
                        const icon = bookmarkButton.querySelector('i');
                        if (isBookmarked(activeTab.url)) {
                            removeBookmark(activeTab.url);
                            icon.className = 'far fa-star';
                        } else {
                            addBookmark(activeTab.url, activeTab.title);
                            icon.className = 'fas fa-star';
                        }
                    }
                });
                
                // Update bookmark button state
                function updateBookmarkButton() {
                    const activeTab = tabs.find(t => t.id === activeTabId);
                    if (activeTab && bookmarkButton) {
                        const icon = bookmarkButton.querySelector('i');
                        if (activeTab.url.startsWith('jq://')) {
                            bookmarkButton.style.display = 'none';
                        } else {
                            bookmarkButton.style.display = 'block';
                            icon.className = isBookmarked(activeTab.url) ? 'fas fa-star' : 'far fa-star';
                        }
                    }
                }
                
                // Home button - navigate current tab instead of creating new
                document.getElementById('home-button')?.addEventListener('click', () => {
                    if (activeTabId) {
                        navigateToUrl('jq://home/');
                    } else {
                        createTab('jq://home/');
                    }
                });
                
                // Downloads button
                document.getElementById('downloads-button')?.addEventListener('click', () => {
                    createTab('jq://downloads/');
                });
                
                // Update downloads badge - make it global
                window.updateDownloadsBadge = function() {
                    const badge = document.getElementById('download-badge');
                    const downloads = getDownloads();
                    if (badge && downloads.length > 0) {
                        badge.textContent = downloads.length;
                        badge.style.display = 'flex';
                    } else if (badge) {
                        badge.style.display = 'none';
                    }
                };
                window.updateDownloadsBadge();
                
                // DevTools toggle
                function toggleDevTools() {
                    let panel = document.getElementById('devtools-panel');
                    if (!panel) {
                        document.body.insertAdjacentHTML('beforeend', getDevToolsHTML());
                        panel = document.getElementById('devtools-panel');
                        initDevTools();
                    }
                    panel.classList.toggle('active');
                }
                
                function initDevTools() {
                    // DevTools tabs
                    document.querySelectorAll('.devtools-tab').forEach(tab => {
                        tab.addEventListener('click', () => {
                            document.querySelectorAll('.devtools-tab').forEach(t => t.classList.remove('active'));
                            document.querySelectorAll('.devtools-tab-content').forEach(c => c.style.display = 'none');
                            tab.classList.add('active');
                            const tabName = tab.dataset.tab;
                            const content = document.getElementById(`devtools-${tabName}`);
                            if (content) {
                                content.style.display = 'block';
                                if (tabName === 'network') updateNetworkTab();
                                if (tabName === 'storage') updateStorageTab();
                                if (tabName === 'source') updateSourceTab();
                            }
                        });
                    });
                    
                    // Close DevTools
                    document.getElementById('devtools-close')?.addEventListener('click', () => {
                        document.getElementById('devtools-panel')?.classList.remove('active');
                    });
                    
                    // F12 shortcut
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'F12') {
                            e.preventDefault();
                            toggleDevTools();
                        }
                    });
                }
                
                function updateNetworkTab() {
                    const tbody = document.getElementById('network-table-body');
                    if (networkRequests.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--color-text-secondary);">No requests yet</td></tr>';
                    } else {
                        tbody.innerHTML = networkRequests.slice(-50).reverse().map(req => `
                            <tr>
                                <td>${req.method || 'GET'}</td>
                                <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${req.url || ''}</td>
                                <td>${req.status || '-'}</td>
                                <td>${req.timestamp ? new Date(req.timestamp).toLocaleTimeString() : '-'}</td>
                            </tr>
                        `).join('');
                    }
                }
                
                function updateStorageTab() {
                    const display = document.getElementById('storage-display');
                    const items = Object.entries(localStorage);
                    if (items.length === 0) {
                        display.innerHTML = '<p style="color: var(--color-text-secondary);">No localStorage items</p>';
                    } else {
                        display.innerHTML = '<table class="data-table"><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>' +
                            items.map(([key, value]) => {
                                let displayValue = value;
                                if (value.length > 100) displayValue = value.substring(0, 100) + '...';
                                return `<tr><td>${key}</td><td style="max-width: 500px; overflow: hidden; text-overflow: ellipsis;">${displayValue}</td></tr>`;
                            }).join('') +
                            '</tbody></table>';
                    }
                }
                
                function updateSourceTab() {
                    const display = document.getElementById('source-display');
                    const activeTab = tabs.find(t => t.id === activeTabId);
                    if (!activeTab || activeTab.url.startsWith('jq://')) {
                        display.textContent = 'Source view is only available for web pages.';
                        return;
                    }
                    const contentElement = document.getElementById(`content-${activeTabId}`);
                    const iframe = contentElement?.querySelector('iframe');
                    if (iframe) {
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            const html = iframeDoc.documentElement.outerHTML;
                            // Format HTML with basic indentation
                            display.textContent = formatHTML(html);
                        } catch (e) {
                            display.textContent = 'Cannot access iframe content due to cross-origin restrictions.\n\nThis is normal for most websites due to browser security policies.';
                        }
                    } else {
                        display.textContent = 'No content available.';
                    }
                }
                
                function formatHTML(html) {
                    // Basic HTML formatting
                    let formatted = '';
                    let indent = 0;
                    const indentSize = 2;
                    html = html.replace(/></g, '>\n<');
                    html.split('\n').forEach(line => {
                        line = line.trim();
                        if (!line) return;
                        if (line.startsWith('</')) indent--;
                        formatted += ' '.repeat(indent * indentSize) + line + '\n';
                        if (line.startsWith('<') && !line.startsWith('</') && !line.endsWith('/>')) indent++;
                    });
                    return formatted;
                }
                
                // Hook into tab switching to update bookmark button
                // We'll call updateBookmarkButton after tab switches
                // This is done by wrapping the switchToTab calls
            }
            
            // Update settings page to include all features
            const originalInitSettings = initSettingsPage;
            initSettingsPage = function() {
                originalInitSettings();
                document.getElementById('save-search-engine-button')?.addEventListener('click', () => {
                    const engine = document.getElementById('search-engine-select').value;
                    setSearchEngine(engine);
                    alert('Search engine saved');
                });
                
                // Privacy controls in settings
                document.getElementById('settings-clear-cookies-button')?.addEventListener('click', () => {
                    if (confirm('Clear all cookies?')) {
                        document.cookie.split(";").forEach(c => {
                            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                        });
                        alert('Cookies cleared');
                    }
                });
                
                document.getElementById('settings-clear-cache-button')?.addEventListener('click', () => {
                    if (confirm('Clear cache?')) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                            alert('Cache cleared');
                        });
                    }
                });
                
                document.getElementById('settings-clear-storage-button')?.addEventListener('click', () => {
                    if (confirm('Clear all localStorage data? This will reset all settings.')) {
                        localStorage.clear();
                        location.reload();
                    }
                });
                
                document.getElementById('settings-clear-all-button')?.addEventListener('click', () => {
                    if (confirm('Clear ALL browsing data? This cannot be undone.')) {
                        localStorage.clear();
                        sessionStorage.clear();
                        document.cookie.split(";").forEach(c => {
                            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                        });
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                        location.reload();
                    }
                });
                
                document.getElementById('settings-view-cookies-button')?.addEventListener('click', () => {
                    const cookies = document.cookie.split(';').map(c => c.trim());
                    const display = document.getElementById('settings-cookies-display');
                    if (cookies.length === 0 || (cookies.length === 1 && cookies[0] === '')) {
                        display.innerHTML = '<p style="color: var(--color-text-secondary);">No cookies found</p>';
                    } else {
                        display.innerHTML = '<table class="data-table"><thead><tr><th>Cookie</th></tr></thead><tbody>' +
                            cookies.map(c => `<tr><td>${c}</td></tr>`).join('') +
                            '</tbody></table>';
                    }
                });
                
                document.getElementById('settings-save-user-agent-button')?.addEventListener('click', () => {
                    const ua = document.getElementById('settings-user-agent-input').value;
                    localStorage.setItem('userAgent', ua);
                    alert('User agent saved');
                });
                
                document.getElementById('clear-statistics-button')?.addEventListener('click', () => {
                    if (confirm('Clear all statistics? This cannot be undone.')) {
                        const stats = getStats();
                        stats.sitesVisited = 0;
                        stats.startDate = Date.now();
                        saveStats(stats);
                        // Reload settings page to show updated stats
                        if (activeTabId) {
                            const tab = tabs.find(t => t.id === activeTabId);
                            if (tab && tab.url === 'jq://settings/') {
                                loadTabContent(activeTabId, 'jq://settings/');
                            }
                        }
                    }
                });
            };
            
            // Track history when pages load
            const originalLoadTabContent = loadTabContent;
            loadTabContent = async function(tabId, url) {
                await originalLoadTabContent(tabId, url);
                const tab = tabs.find(t => t.id === tabId);
                if (tab && !url.startsWith('jq://')) {
                    addToHistory(url, tab.title);
                    updateStats(url);
                }
                // Update downloads badge
                if (typeof window.updateDownloadsBadge === 'function') {
                    window.updateDownloadsBadge();
                }
            };
            
            // Load settings immediately
            loadSavedSettings();
            
            // Initialize theme
            setTheme(getTheme());
            
            // Apply custom theme color if set
            const savedThemeColor = localStorage.getItem('themeColor');
            const savedThemeColorSecondary = localStorage.getItem('themeColorSecondary');
            if (savedThemeColor && /^#[0-9A-F]{6}$/i.test(savedThemeColor)) {
                document.documentElement.style.setProperty('--color-primary', savedThemeColor);
                document.documentElement.style.setProperty('--color-link', savedThemeColor);
            }
            if (savedThemeColorSecondary && /^#[0-9A-F]{6}$/i.test(savedThemeColorSecondary)) {
                document.documentElement.style.setProperty('--color-primary-secondary', savedThemeColorSecondary);
            }
            
            // Initialize UI handlers
            initUIHandlers();
            
            // Initialize navigation buttons (disabled until first tab is created)
            updateNavigationButtons(null);
            
            // Update bookmark bar
            updateBookmarkBar();

            // Create initial tab
            createTab('jq://home/');

            // Re-initialize new tab handlers when content is loaded
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1 && node.classList.contains('tab-content')) {
                            const newtabContent = node.querySelector('.new-tab-content');
                            if (newtabContent) {
                                setTimeout(() => initNewTabHandlers(node), 100);
                            }
                        }
                    });
                });
            });
            observer.observe(browserContent, { childList: true, subtree: true });

            // Make closeTab and createTab available globally
            window.closeTab = closeTab;
            window.createTab = createTab;
            
            // Override window.open() to use our tab system
            const originalWindowOpen = window.open;
            window.open = function(url, target, features) {
                // If target is _blank or not specified, open in new tab
                if (!target || target === '_blank') {
                    if (url) {
                        const normalized = normalizeUrl(url);
                        createTab(normalized);
                    } else {
                        createTab();
                    }
                    return null; // Return null like window.open() does for blocked popups
                }
                // For other targets, try to use original behavior
                try {
                    return originalWindowOpen.call(this, url, target, features);
                } catch (e) {
                    // If original fails, open in new tab
                    if (url) {
                        createTab(normalizeUrl(url));
                    }
                    return null;
                }
            };
        })();
    </script>
</body>
</html>
